#!/usr/bin/env bun

/**
 * Morning Dashboard v2.2
 * A comprehensive morning productivity dashboard
 * 
 * Features:
 * - Gmail unread emails
 * - Google Calendar events
 * - Todoist tasks (today + overdue + upcoming)
 * - Weather forecast
 * - Motivational quotes
 * - GitHub notifications
 * - Focus time suggestions
 * - System health (battery)
 * - Web GUI mode
 * - Interactive setup wizard
 * - Configurable via file or CLI flags
 */

const { execSync, spawn, spawnSync } = require('child_process');
const fs = require('fs');
const path = require('path');
const os = require('os');
const http = require('http');
const readline = require('readline');

// â”€â”€â”€ Version â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const VERSION = '2.2.0';

// â”€â”€â”€ Paths â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const CONFIG_DIR = path.join(os.homedir(), '.config/morning-dashboard');
const CONFIG_PATH = path.join(CONFIG_DIR, 'config.json');
const CREDENTIALS_PATH = path.join(CONFIG_DIR, 'credentials.json');

// â”€â”€â”€ Default Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const DEFAULT_CONFIG = {
  google: {
    enabled: true,
    account: '', // Will be set during setup
  },
  gmail: {
    enabled: true,
    maxEmails: 10,
    query: 'is:unread newer_than:3d',
  },
  calendar: {
    enabled: true,
    id: 'primary',
    showFocusTime: true,
    lookaheadDays: 1,
  },
  todoist: {
    enabled: true,
    apiToken: '', // Will be set during setup
    showUpcoming: true,
    upcomingDays: 7,
  },
  weather: {
    enabled: true,
    location: '',
    units: 'metric',
  },
  quote: {
    enabled: true,
  },
  github: {
    enabled: true,
    maxNotifications: 5,
  },
  system: {
    enabled: true,
    showBattery: true,
  },
  gui: {
    port: 3141,
    autoRefresh: true,
    refreshInterval: 300,
    theme: 'auto',
  },
  display: {
    width: 80,
    maxTasksShown: 12,
    maxEmailsShown: 6,
    maxEventsShown: 8,
    compact: false,
    color: true,
    showGreeting: true,
    showSummary: true,
  },
  review: {
    // Communication tracking
    emails: { enabled: true },
    slack: {
      enabled: false,
      tokenPath: '', // Path to slack token JSON file
    },
    xcom: {
      enabled: false,
      sshHost: '', // e.g., user@hostname
      birdPath: '~/Code/bird',
    },
    // Meetings
    fireflies: {
      enabled: false,
      apiKey: '',
      speakerName: '', // Your name for speaker verification
    },
    // Output tracking
    gitReposFolder: '~/Documents/Development', // Folder to scan for git repos
    googleDocs: { enabled: true },
    // Focus time
    activityWatch: { enabled: true },
    screenTime: {
      enabled: true,
      // If empty, queries local Mac. If set, uses SSH
      sshHost: '',
      scriptPath: '~/get_screentime.py',
    },
  },
  // Native macOS integrations
  appleCalendar: {
    enabled: false, // Uses native Calendar.app via AppleScript
    lookaheadDays: 7,
    calendars: [], // Empty = all calendars
  },
  appleMail: {
    enabled: false, // Uses native Mail.app via AppleScript
    maxEmails: 10,
    mailbox: 'INBOX',
    account: '', // Empty = all accounts
  },
  // Financial tracking
  stocks: {
    enabled: false,
    symbols: ['AAPL', 'MSFT', 'GOOGL'], // Stock symbols to track
    showChange: true,
  },
  // Expense tracking
  expenses: {
    enabled: false,
    // Uses receipt-tracker skill with Telegram â†’ n8n â†’ Sheets
    googleSheetId: '',
    showWeekly: true,
  },
};

// â”€â”€â”€ Configuration Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function ensureConfigDir() {
  if (!fs.existsSync(CONFIG_DIR)) {
    fs.mkdirSync(CONFIG_DIR, { recursive: true });
  }
}

function loadConfig() {
  const configPaths = [
    CONFIG_PATH,
    path.join(os.homedir(), '.morning-dashboard.json'),
    path.join(__dirname, 'config.json'),
  ];

  for (const configPath of configPaths) {
    if (fs.existsSync(configPath)) {
      try {
        const userConfig = JSON.parse(fs.readFileSync(configPath, 'utf-8'));
        return deepMerge(DEFAULT_CONFIG, userConfig);
      } catch (e) {
        console.error(`Warning: Could not parse config at ${configPath}`);
      }
    }
  }

  return DEFAULT_CONFIG;
}

function saveConfig(config) {
  ensureConfigDir();
  fs.writeFileSync(CONFIG_PATH, JSON.stringify(config, null, 2));
}

function deepMerge(target, source) {
  const result = { ...target };
  for (const key of Object.keys(source)) {
    if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
      result[key] = deepMerge(target[key] || {}, source[key]);
    } else {
      result[key] = source[key];
    }
  }
  return result;
}

// â”€â”€â”€ CLI Arguments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function parseArgs() {
  const args = process.argv.slice(2);
  const options = {
    command: null, // setup, gui, review, or null for dashboard
    subcommand: null, // status, google, todoist, github
    reviewDate: null, // date for review command
    help: false,
    version: false,
    compact: false,
    json: false,
    noColor: false,
    sections: [],
    configPath: null,
    port: null,
  };

  for (let i = 0; i < args.length; i++) {
    const arg = args[i];
    switch (arg) {
      case 'setup':
        options.command = 'setup';
        if (args[i + 1] && !args[i + 1].startsWith('-')) {
          options.subcommand = args[++i];
        }
        break;
      case 'gui':
        options.command = 'gui';
        break;
      case 'review':
        options.command = 'review';
        // Check if next arg is a date (YYYY-MM-DD format)
        if (args[i + 1] && /^\d{4}-\d{2}-\d{2}$/.test(args[i + 1])) {
          options.reviewDate = args[++i];
        }
        break;
      case '-h':
      case '--help':
        options.help = true;
        break;
      case '-v':
      case '--version':
        options.version = true;
        break;
      case '-c':
      case '--compact':
        options.compact = true;
        break;
      case '-j':
      case '--json':
        options.json = true;
        break;
      case '--no-color':
        options.noColor = true;
        break;
      case '-s':
      case '--section':
        if (args[i + 1]) {
          options.sections.push(args[++i]);
        }
        break;
      case '--config':
        if (args[i + 1]) {
          options.configPath = args[++i];
        }
        break;
      case '--tasks':
        options.sections.push('tasks');
        break;
      case '--calendar':
        options.sections.push('calendar');
        break;
      case '--email':
        options.sections.push('email');
        break;
      case '--weather':
        options.sections.push('weather');
        break;
      case '--github':
        options.sections.push('github');
        break;
      case '-p':
      case '--port':
        if (args[i + 1]) {
          options.port = parseInt(args[++i], 10);
        }
        break;
    }
  }

  return options;
}

function showHelp() {
  console.log(`
â˜€ï¸  Morning Dashboard v${VERSION}

Usage:
  mdash                     Show dashboard in terminal
  mdash gui [--port <n>]    Launch web dashboard
  mdash setup [command]     Configure integrations
  mdash review [YYYY-MM-DD] Daily performance review

Dashboard Options:
  -h, --help          Show this help message
  -v, --version       Show version number
  -c, --compact       Compact output mode
  -j, --json          Output as JSON
  --no-color          Disable colors
  --config <path>     Use custom config file
  
Section filters:
  --tasks             Show only tasks
  --calendar          Show only calendar
  --email             Show only emails
  --weather           Show only weather
  --github            Show only GitHub notifications
  --stocks            Show only stocks
  --apple-calendar    Show only Apple Calendar events
  --apple-mail        Show only Apple Mail messages

Setup Commands:
  mdash setup              Interactive setup wizard
  mdash setup status       Show integration status
  mdash setup google       Configure Google (Gmail + Calendar)
  mdash setup todoist      Configure Todoist
  mdash setup github       Configure GitHub
  mdash setup weather      Configure weather location
  mdash setup review       Configure daily review data sources

GUI Options:
  mdash gui                Launch web dashboard
  mdash gui --port 8080    Use custom port (default: 3141)

Review Options:
  mdash review             Daily performance review (today)
  mdash review 2026-01-15  Review for specific date

Configuration:
  Config: ~/.config/morning-dashboard/config.json

Examples:
  mdash                    Full dashboard
  mdash setup              Run setup wizard
  mdash gui                Open web dashboard
  mdash review             Daily performance review
  mdash --compact          Compact terminal view
  mdash --json             JSON output for scripting
`);
}

// â”€â”€â”€ ANSI Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let useColor = true;

const colors = {
  reset: () => useColor ? '\x1b[0m' : '',
  bold: () => useColor ? '\x1b[1m' : '',
  dim: () => useColor ? '\x1b[2m' : '',
  italic: () => useColor ? '\x1b[3m' : '',
  red: () => useColor ? '\x1b[31m' : '',
  green: () => useColor ? '\x1b[32m' : '',
  yellow: () => useColor ? '\x1b[33m' : '',
  blue: () => useColor ? '\x1b[34m' : '',
  magenta: () => useColor ? '\x1b[35m' : '',
  cyan: () => useColor ? '\x1b[36m' : '',
  white: () => useColor ? '\x1b[37m' : '',
  gray: () => useColor ? '\x1b[90m' : '',
};

const c = new Proxy(colors, {
  get: (target, prop) => target[prop] ? target[prop]() : '',
});

// â”€â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function exec(cmd, options = {}) {
  try {
    const result = execSync(cmd, {
      encoding: 'utf-8',
      stdio: ['pipe', 'pipe', 'pipe'],
      timeout: options.timeout || 15000,
      env: { ...process.env, ...options.env },
      ...options,
    });
    return result.trim();
  } catch (e) {
    return null;
  }
}

function parseJSON(str) {
  try {
    return JSON.parse(str);
  } catch {
    return null;
  }
}

function truncate(str, len) {
  if (!str) return '';
  str = String(str);
  return str.length > len ? str.slice(0, len - 1) + 'â€¦' : str;
}

function padRight(str, len) {
  return (str || '').toString().padEnd(len);
}

function stripAnsi(str) {
  return str.replace(/\x1b\[[0-9;]*m/g, '');
}

function formatTime(isoString) {
  if (!isoString) return '';
  const d = new Date(isoString);
  return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
}

function formatRelativeTime(date) {
  const now = new Date();
  const diff = date - now;
  const mins = Math.floor(diff / 60000);
  const hours = Math.floor(mins / 60);
  
  if (mins < 0) return 'now';
  if (mins < 60) return `in ${mins}m`;
  if (hours < 24) return `in ${hours}h ${mins % 60}m`;
  return `in ${Math.floor(hours / 24)}d`;
}

function getGreeting() {
  const hour = new Date().getHours();
  if (hour < 12) return 'Good morning';
  if (hour < 17) return 'Good afternoon';
  return 'Good evening';
}

function getDateRange(days) {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const end = new Date(start);
  end.setDate(end.getDate() + days);
  return { from: start.toISOString(), to: end.toISOString() };
}

/**
 * Convert Todoist task URLs from old format to new format
 * Old: https://app.todoist.com/showTask?id=TASKID
 * New: https://todoist.com/app/task/TASKID
 */
function todoistTaskUrl(taskIdOrUrl) {
  if (!taskIdOrUrl) return null;

  // If it's already a URL, transform it
  if (typeof taskIdOrUrl === 'string' && taskIdOrUrl.includes('todoist.com')) {
    // Old format: https://app.todoist.com/showTask?id=123
    const showTaskMatch = taskIdOrUrl.match(/showTask\?id=(\d+)/);
    if (showTaskMatch) {
      return `https://todoist.com/app/task/${showTaskMatch[1]}`;
    }
    // Already new format or other format, return as-is
    if (taskIdOrUrl.includes('/app/task/')) {
      return taskIdOrUrl;
    }
    // Try to extract ID from any URL format
    const idMatch = taskIdOrUrl.match(/(\d{10,})/);
    if (idMatch) {
      return `https://todoist.com/app/task/${idMatch[1]}`;
    }
    return taskIdOrUrl;
  }

  // If it's just an ID, construct the new URL
  return `https://todoist.com/app/task/${taskIdOrUrl}`;
}

// â”€â”€â”€ Setup & Integration Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function checkGogInstalled() {
  return exec('which gog 2>/dev/null') !== null;
}

function checkGhInstalled() {
  return exec('which gh 2>/dev/null') !== null;
}

function getGoogleAccounts() {
  if (!checkGogInstalled()) return [];
  const raw = exec('gog auth list --json 2>/dev/null');
  const data = parseJSON(raw);
  return data?.accounts || [];
}

function getGoogleAccountServices(email) {
  const accounts = getGoogleAccounts();
  const account = accounts.find(a => a.email === email);
  return account?.services || [];
}

function checkGoogleSetup(config) {
  if (!checkGogInstalled()) {
    return { installed: false, authenticated: false, account: null, services: [] };
  }
  
  const accounts = getGoogleAccounts();
  const configAccount = config.google?.account;
  
  // Find matching account or use first one
  let account = accounts.find(a => a.email === configAccount);
  if (!account && accounts.length > 0) {
    account = accounts[0];
  }
  
  const hasCalendar = account?.services?.includes('calendar');
  const hasGmail = account?.services?.includes('gmail');
  
  return {
    installed: true,
    authenticated: !!account,
    account: account?.email || null,
    services: account?.services || [],
    hasCalendar,
    hasGmail,
  };
}

function checkTodoistSetup(config) {
  // Check for API token in config or environment
  const token = config.todoist?.apiToken || process.env.TODOIST_API_TOKEN;
  if (!token) {
    return { configured: false, working: false };
  }
  
  // Test the API
  const raw = exec(`curl -s -H "Authorization: Bearer ${token}" "https://api.todoist.com/rest/v2/projects" 2>/dev/null`, { timeout: 5000 });
  const data = parseJSON(raw);
  
  return {
    configured: true,
    working: Array.isArray(data),
    hasToken: !!token,
  };
}

function checkGitHubSetup() {
  if (!checkGhInstalled()) {
    return { installed: false, authenticated: false, user: null };
  }
  
  const raw = exec('gh auth status 2>&1');
  const authenticated = raw?.includes('Logged in to');
  
  let user = null;
  if (authenticated) {
    const userRaw = exec('gh api user --jq .login 2>/dev/null');
    user = userRaw || null;
  }
  
  return { installed: true, authenticated, user };
}

function getIntegrationStatus(config) {
  return {
    google: checkGoogleSetup(config),
    todoist: checkTodoistSetup(config),
    github: checkGitHubSetup(),
    weather: {
      configured: true, // Always available via wttr.in
      location: config.weather?.location || 'auto-detect',
    },
  };
}

// â”€â”€â”€ Setup Commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function prompt(question) {
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  });
  
  return new Promise(resolve => {
    rl.question(question, answer => {
      rl.close();
      resolve(answer.trim());
    });
  });
}

async function runSetupStatus(config) {
  console.log(`\n${c.bold}â˜€ï¸  Morning Dashboard - Integration Status${c.reset}\n`);
  console.log(`${c.dim}${'â”€'.repeat(50)}${c.reset}`);
  
  const status = getIntegrationStatus(config);
  
  // Google
  console.log(`\n${c.bold}Google (Gmail + Calendar)${c.reset}`);
  if (!status.google.installed) {
    console.log(`  ${c.red}âœ—${c.reset} gog CLI not installed`);
    console.log(`  ${c.dim}Install: brew install steipete/tap/gogcli${c.reset}`);
  } else if (!status.google.authenticated) {
    console.log(`  ${c.yellow}â—‹${c.reset} Not authenticated`);
    console.log(`  ${c.dim}Run: mdash setup google${c.reset}`);
  } else {
    console.log(`  ${c.green}âœ“${c.reset} Account: ${status.google.account}`);
    console.log(`  ${c.green}âœ“${c.reset} Services: ${status.google.services.join(', ')}`);
  }
  
  // Todoist
  console.log(`\n${c.bold}Todoist${c.reset}`);
  if (!status.todoist.configured) {
    console.log(`  ${c.yellow}â—‹${c.reset} API token not configured`);
    console.log(`  ${c.dim}Run: mdash setup todoist${c.reset}`);
  } else if (!status.todoist.working) {
    console.log(`  ${c.red}âœ—${c.reset} API token invalid or expired`);
    console.log(`  ${c.dim}Run: mdash setup todoist${c.reset}`);
  } else {
    console.log(`  ${c.green}âœ“${c.reset} Connected and working`);
  }
  
  // GitHub
  console.log(`\n${c.bold}GitHub${c.reset}`);
  if (!status.github.installed) {
    console.log(`  ${c.yellow}â—‹${c.reset} gh CLI not installed (optional)`);
    console.log(`  ${c.dim}Install: brew install gh${c.reset}`);
  } else if (!status.github.authenticated) {
    console.log(`  ${c.yellow}â—‹${c.reset} Not authenticated`);
    console.log(`  ${c.dim}Run: mdash setup github${c.reset}`);
  } else {
    console.log(`  ${c.green}âœ“${c.reset} Logged in as: ${status.github.user}`);
  }
  
  // Weather
  console.log(`\n${c.bold}Weather${c.reset}`);
  console.log(`  ${c.green}âœ“${c.reset} Available (no setup required)`);
  console.log(`  ${c.dim}Location: ${status.weather.location}${c.reset}`);
  
  console.log(`\n${c.dim}${'â”€'.repeat(50)}${c.reset}`);
  console.log(`\nConfig file: ${c.cyan}${CONFIG_PATH}${c.reset}\n`);
}

async function runSetupGoogle(config) {
  console.log(`\n${c.bold}â˜€ï¸  Google Setup (Gmail + Calendar)${c.reset}\n`);
  
  // Check if gog is installed
  if (!checkGogInstalled()) {
    console.log(`${c.red}âœ—${c.reset} gog CLI is not installed.\n`);
    console.log(`Install it with:`);
    console.log(`  ${c.cyan}brew install steipete/tap/gogcli${c.reset}\n`);
    
    const install = await prompt('Install now? [y/N] ');
    if (install.toLowerCase() === 'y') {
      console.log(`\nInstalling gog...`);
      try {
        execSync('brew install steipete/tap/gogcli', { stdio: 'inherit' });
        console.log(`\n${c.green}âœ“${c.reset} gog installed successfully!\n`);
      } catch (e) {
        console.log(`\n${c.red}âœ—${c.reset} Installation failed. Please install manually.\n`);
        return;
      }
    } else {
      return;
    }
  }
  
  // Check existing accounts
  const accounts = getGoogleAccounts();
  
  if (accounts.length > 0) {
    console.log(`${c.green}âœ“${c.reset} Found existing Google account(s):\n`);
    accounts.forEach((acc, i) => {
      console.log(`  ${i + 1}. ${acc.email}`);
      console.log(`     Services: ${acc.services.join(', ')}`);
    });
    console.log();
    
    const useExisting = await prompt('Use an existing account? [Y/n] ');
    if (useExisting.toLowerCase() !== 'n') {
      let selectedAccount = accounts[0];
      if (accounts.length > 1) {
        const choice = await prompt(`Select account (1-${accounts.length}): `);
        const idx = parseInt(choice) - 1;
        if (idx >= 0 && idx < accounts.length) {
          selectedAccount = accounts[idx];
        }
      }
      
      // Check if it has required services
      const hasCalendar = selectedAccount.services.includes('calendar');
      const hasGmail = selectedAccount.services.includes('gmail');
      
      if (!hasCalendar || !hasGmail) {
        console.log(`\n${c.yellow}âš ${c.reset} Account is missing some services.`);
        console.log(`  Calendar: ${hasCalendar ? c.green + 'âœ“' : c.red + 'âœ—'}${c.reset}`);
        console.log(`  Gmail: ${hasGmail ? c.green + 'âœ“' : c.red + 'âœ—'}${c.reset}`);
        
        const reauth = await prompt('\nRe-authorize with all services? [Y/n] ');
        if (reauth.toLowerCase() !== 'n') {
          console.log(`\nOpening browser for authorization...`);
          try {
            execSync(`gog auth add ${selectedAccount.email} --services gmail,calendar --force`, { stdio: 'inherit' });
          } catch (e) {
            console.log(`\n${c.red}âœ—${c.reset} Authorization failed.\n`);
            return;
          }
        }
      }
      
      // Save to config
      config.google = config.google || {};
      config.google.account = selectedAccount.email;
      config.google.enabled = true;
      saveConfig(config);
      
      console.log(`\n${c.green}âœ“${c.reset} Google configured: ${selectedAccount.email}`);
      console.log(`  Config saved to: ${CONFIG_PATH}\n`);
      return;
    }
  }
  
  // Add new account
  console.log(`\n${c.bold}Add a new Google account${c.reset}\n`);
  console.log(`This will open your browser to authorize Morning Dashboard.`);
  console.log(`The app will request access to Gmail and Calendar.\n`);
  
  // Check for OAuth credentials
  const gogConfigPath = path.join(os.homedir(), 'Library/Application Support/gogcli/config.json');
  let hasCredentials = false;
  
  if (fs.existsSync(gogConfigPath)) {
    const gogConfig = parseJSON(fs.readFileSync(gogConfigPath, 'utf-8'));
    hasCredentials = !!gogConfig?.oauth?.client_id;
  }
  
  if (!hasCredentials) {
    console.log(`${c.yellow}âš ${c.reset} OAuth credentials not found.\n`);
    console.log(`You need to set up Google Cloud OAuth credentials first:`);
    console.log(`  1. Go to ${c.cyan}https://console.cloud.google.com/apis/credentials${c.reset}`);
    console.log(`  2. Create a new OAuth 2.0 Client ID (Desktop app)`);
    console.log(`  3. Download the JSON file`);
    console.log(`  4. Run: ${c.cyan}gog auth credentials /path/to/client_secret.json${c.reset}\n`);
    
    const credPath = await prompt('Path to client_secret.json (or press Enter to skip): ');
    if (credPath) {
      if (fs.existsSync(credPath)) {
        try {
          execSync(`gog auth credentials "${credPath}"`, { stdio: 'inherit' });
          console.log(`\n${c.green}âœ“${c.reset} Credentials stored.\n`);
        } catch (e) {
          console.log(`\n${c.red}âœ—${c.reset} Failed to store credentials.\n`);
          return;
        }
      } else {
        console.log(`\n${c.red}âœ—${c.reset} File not found: ${credPath}\n`);
        return;
      }
    } else {
      return;
    }
  }
  
  const email = await prompt('Google account email: ');
  if (!email || !email.includes('@')) {
    console.log(`\n${c.red}âœ—${c.reset} Invalid email.\n`);
    return;
  }
  
  console.log(`\nOpening browser for authorization...`);
  try {
    execSync(`gog auth add ${email} --services gmail,calendar`, { stdio: 'inherit' });
  } catch (e) {
    console.log(`\n${c.red}âœ—${c.reset} Authorization failed.\n`);
    return;
  }
  
  // Save to config
  config.google = config.google || {};
  config.google.account = email;
  config.google.enabled = true;
  saveConfig(config);
  
  console.log(`\n${c.green}âœ“${c.reset} Google configured: ${email}`);
  console.log(`  Config saved to: ${CONFIG_PATH}\n`);
}

async function runSetupTodoist(config) {
  console.log(`\n${c.bold}â˜€ï¸  Todoist Setup${c.reset}\n`);
  
  // Check existing setup
  const status = checkTodoistSetup(config);
  if (status.working) {
    console.log(`${c.green}âœ“${c.reset} Todoist is already configured and working.\n`);
    const reconfigure = await prompt('Reconfigure? [y/N] ');
    if (reconfigure.toLowerCase() !== 'y') {
      return;
    }
  }
  
  console.log(`To get your Todoist API token:`);
  console.log(`  1. Go to ${c.cyan}https://todoist.com/app/settings/integrations/developer${c.reset}`);
  console.log(`  2. Copy your API token\n`);
  
  const openBrowser = await prompt('Open Todoist settings in browser? [Y/n] ');
  if (openBrowser.toLowerCase() !== 'n') {
    const openCmd = process.platform === 'darwin' ? 'open' : 'xdg-open';
    spawn(openCmd, ['https://todoist.com/app/settings/integrations/developer'], { detached: true, stdio: 'ignore' }).unref();
    console.log();
  }
  
  const token = await prompt('Paste your API token: ');
  if (!token) {
    console.log(`\n${c.red}âœ—${c.reset} No token provided.\n`);
    return;
  }
  
  // Verify token
  console.log(`\nVerifying token...`);
  const raw = exec(`curl -s -H "Authorization: Bearer ${token}" "https://api.todoist.com/rest/v2/projects" 2>/dev/null`, { timeout: 5000 });
  const data = parseJSON(raw);
  
  if (!Array.isArray(data)) {
    console.log(`${c.red}âœ—${c.reset} Invalid token or API error.\n`);
    return;
  }
  
  // Save to config
  config.todoist = config.todoist || {};
  config.todoist.apiToken = token;
  config.todoist.enabled = true;
  saveConfig(config);
  
  console.log(`${c.green}âœ“${c.reset} Todoist configured successfully!`);
  console.log(`  Found ${data.length} project(s)`);
  console.log(`  Config saved to: ${CONFIG_PATH}\n`);
}

async function runSetupGitHub(config) {
  console.log(`\n${c.bold}â˜€ï¸  GitHub Setup${c.reset}\n`);
  
  // Check if gh is installed
  if (!checkGhInstalled()) {
    console.log(`${c.yellow}â—‹${c.reset} GitHub CLI (gh) is not installed.\n`);
    console.log(`GitHub notifications are optional. Install with:`);
    console.log(`  ${c.cyan}brew install gh${c.reset}\n`);
    
    const install = await prompt('Install now? [y/N] ');
    if (install.toLowerCase() === 'y') {
      console.log(`\nInstalling gh...`);
      try {
        execSync('brew install gh', { stdio: 'inherit' });
        console.log(`\n${c.green}âœ“${c.reset} gh installed successfully!\n`);
      } catch (e) {
        console.log(`\n${c.red}âœ—${c.reset} Installation failed. Please install manually.\n`);
        return;
      }
    } else {
      return;
    }
  }
  
  // Check existing auth
  const status = checkGitHubSetup();
  if (status.authenticated) {
    console.log(`${c.green}âœ“${c.reset} Already logged in as: ${status.user}\n`);
    const reauth = await prompt('Re-authenticate? [y/N] ');
    if (reauth.toLowerCase() !== 'y') {
      return;
    }
  }
  
  console.log(`\nThis will open your browser to authenticate with GitHub.\n`);
  
  try {
    execSync('gh auth login', { stdio: 'inherit' });
    
    // Verify
    const newStatus = checkGitHubSetup();
    if (newStatus.authenticated) {
      console.log(`\n${c.green}âœ“${c.reset} GitHub configured: ${newStatus.user}\n`);
    }
  } catch (e) {
    console.log(`\n${c.red}âœ—${c.reset} Authentication failed.\n`);
  }
}

async function runSetupWeather(config) {
  console.log(`\n${c.bold}â˜€ï¸  Weather Setup${c.reset}\n`);
  
  const currentLocation = config.weather?.location || '';
  console.log(`Current location: ${currentLocation || '(auto-detect by IP)'}\n`);
  
  console.log(`Enter a location (city name, ZIP code, or coordinates).`);
  console.log(`Leave empty to auto-detect by IP address.\n`);
  
  const location = await prompt('Location: ');
  
  // Test the location
  if (location) {
    console.log(`\nTesting location...`);
    const raw = exec(`curl -s "wttr.in/${encodeURIComponent(location)}?format=j1" 2>/dev/null`, { timeout: 5000 });
    const data = parseJSON(raw);
    
    if (data?.nearest_area?.[0]) {
      const area = data.nearest_area[0];
      const areaName = area.areaName?.[0]?.value || location;
      const region = area.region?.[0]?.value || '';
      const country = area.country?.[0]?.value || '';
      console.log(`${c.green}âœ“${c.reset} Found: ${areaName}${region ? ', ' + region : ''}${country ? ', ' + country : ''}`);
    } else {
      console.log(`${c.yellow}âš ${c.reset} Could not verify location, but saving anyway.`);
    }
  }
  
  // Save to config
  config.weather = config.weather || {};
  config.weather.location = location;
  saveConfig(config);
  
  console.log(`\n${c.green}âœ“${c.reset} Weather location saved.`);
  console.log(`  Config saved to: ${CONFIG_PATH}\n`);
  
  // Ask about units
  const currentUnits = config.weather?.units || 'imperial';
  console.log(`Current units: ${currentUnits}`);
  const changeUnits = await prompt('Change units? (imperial/metric) [Enter to skip]: ');
  
  if (changeUnits === 'metric' || changeUnits === 'imperial') {
    config.weather.units = changeUnits;
    saveConfig(config);
    console.log(`${c.green}âœ“${c.reset} Units set to ${changeUnits}\n`);
  }
}

async function runSetupReview(config) {
  console.log(`\n${c.bold}ðŸ† Daily Review Setup${c.reset}\n`);
  console.log(`Configure data sources for your daily performance review.\n`);
  console.log(`${c.dim}${'â”€'.repeat(50)}${c.reset}\n`);

  config.review = config.review || {};

  // â”€â”€â”€ Communication â”€â”€â”€
  console.log(`${c.bold}ðŸ“¬ Communication Tracking${c.reset}\n`);

  // Emails (uses existing Google setup)
  const googleCheck = checkGoogleSetup(config);
  if (googleCheck.hasGmail) {
    console.log(`${c.green}âœ“${c.reset} Emails: Using Google account (${googleCheck.account})`);
    config.review.emails = { enabled: true };
  } else {
    console.log(`${c.yellow}â—‹${c.reset} Emails: Google not configured (run: mdash setup google)`);
    config.review.emails = { enabled: false };
  }

  // Slack
  console.log();
  const enableSlack = await prompt('Enable Slack message tracking? [y/N]: ');
  if (enableSlack.toLowerCase() === 'y') {
    const tokenPath = await prompt('Path to Slack token JSON file (or Enter to skip): ');
    config.review.slack = {
      enabled: !!tokenPath,
      tokenPath: tokenPath || '',
    };
    if (tokenPath) {
      console.log(`${c.green}âœ“${c.reset} Slack enabled`);
    }
  } else {
    config.review.slack = { enabled: false, tokenPath: '' };
    console.log(`${c.dim}Slack disabled${c.reset}`);
  }

  // X.com / Twitter
  console.log();
  const enableXcom = await prompt('Enable X.com/Twitter tracking (requires Bird CLI)? [y/N]: ');
  if (enableXcom.toLowerCase() === 'y') {
    const sshHost = await prompt('SSH host for Bird CLI (e.g., user@hostname, or Enter for local): ');
    const birdPath = await prompt('Bird CLI path [~/Code/bird]: ') || '~/Code/bird';
    config.review.xcom = {
      enabled: true,
      sshHost: sshHost || '',
      birdPath,
    };
    console.log(`${c.green}âœ“${c.reset} X.com enabled${sshHost ? ' via SSH to ' + sshHost : ' (local)'}`);
  } else {
    config.review.xcom = { enabled: false, sshHost: '', birdPath: '' };
    console.log(`${c.dim}X.com disabled${c.reset}`);
  }

  // â”€â”€â”€ Meetings â”€â”€â”€
  console.log(`\n${c.bold}ðŸ“… Meetings${c.reset}\n`);

  const enableFireflies = await prompt('Enable Fireflies meeting tracking? [y/N]: ');
  if (enableFireflies.toLowerCase() === 'y') {
    const apiKey = await prompt('Fireflies API key: ');
    const speakerName = await prompt('Your name (for speaker verification): ');
    config.review.fireflies = {
      enabled: !!apiKey,
      apiKey: apiKey || '',
      speakerName: speakerName || '',
    };
    if (apiKey) {
      console.log(`${c.green}âœ“${c.reset} Fireflies enabled`);
    }
  } else {
    config.review.fireflies = { enabled: false, apiKey: '', speakerName: '' };
    console.log(`${c.dim}Fireflies disabled${c.reset}`);
  }

  // â”€â”€â”€ Output â”€â”€â”€
  console.log(`\n${c.bold}ðŸ’» Output Tracking${c.reset}\n`);

  // Git repos folder
  const currentFolder = config.review?.gitReposFolder || '~/Documents/Development';
  console.log(`Current git repos folder: ${currentFolder}`);
  const gitFolder = await prompt(`Git repos folder [${currentFolder}]: `) || currentFolder;
  const expandedFolder = gitFolder.replace(/^~/, os.homedir());

  if (fs.existsSync(expandedFolder)) {
    config.review.gitReposFolder = gitFolder;
    // Count repos in folder
    const findCmd = `find "${expandedFolder}" -maxdepth 2 -type d -name ".git" 2>/dev/null | wc -l`;
    const repoCount = exec(findCmd, { timeout: 5000 })?.trim() || '0';
    console.log(`${c.green}âœ“${c.reset} Found ${repoCount} git repos in ${gitFolder}`);
  } else {
    console.log(`${c.yellow}âš ${c.reset} Folder not found, using default`);
    config.review.gitReposFolder = '~/Documents/Development';
  }

  // Google Docs
  if (googleCheck.authenticated) {
    config.review.googleDocs = { enabled: true };
    console.log(`${c.green}âœ“${c.reset} Google Docs: enabled`);
  } else {
    config.review.googleDocs = { enabled: false };
  }

  // â”€â”€â”€ Focus Time â”€â”€â”€
  console.log(`\n${c.bold}â±ï¸ Focus Time${c.reset}\n`);

  // ActivityWatch
  const awRunning = exec(`curl -sL 'http://127.0.0.1:5600/api/0/info' 2>/dev/null`, { timeout: 2000 });
  if (awRunning) {
    console.log(`${c.green}âœ“${c.reset} ActivityWatch: detected and running`);
    config.review.activityWatch = { enabled: true };
  } else {
    const enableAW = await prompt('Enable ActivityWatch (not currently running)? [Y/n]: ');
    config.review.activityWatch = { enabled: enableAW.toLowerCase() !== 'n' };
    if (config.review.activityWatch.enabled) {
      console.log(`${c.yellow}â—‹${c.reset} ActivityWatch: enabled (start it to collect data)`);
    } else {
      console.log(`${c.dim}ActivityWatch disabled${c.reset}`);
    }
  }

  // Screen Time
  console.log();
  const enableScreenTime = await prompt('Enable macOS Screen Time tracking? [Y/n]: ');
  if (enableScreenTime.toLowerCase() !== 'n') {
    const sshHost = await prompt('SSH host (Enter for local Mac): ');
    config.review.screenTime = {
      enabled: true,
      sshHost: sshHost || '',
      scriptPath: '~/get_screentime.py',
    };
    console.log(`${c.green}âœ“${c.reset} Screen Time: enabled${sshHost ? ' via SSH to ' + sshHost : ' (local)'}`);
  } else {
    config.review.screenTime = { enabled: false, sshHost: '', scriptPath: '' };
    console.log(`${c.dim}Screen Time disabled${c.reset}`);
  }

  // Save config
  saveConfig(config);

  console.log(`\n${c.dim}${'â”€'.repeat(50)}${c.reset}`);
  console.log(`\n${c.green}âœ“${c.reset} Daily Review configuration saved!`);
  console.log(`  Config: ${CONFIG_PATH}`);
  console.log(`\n  Run ${c.cyan}mdash review${c.reset} to generate your daily review.\n`);
}

async function runSetupWizard(config) {
  console.log(`\n${c.bold}â˜€ï¸  Morning Dashboard Setup Wizard${c.reset}\n`);
  console.log(`This will help you configure your integrations.\n`);
  console.log(`${c.dim}${'â”€'.repeat(50)}${c.reset}\n`);
  
  // Show current status
  const status = getIntegrationStatus(config);
  
  // Google
  if (!status.google.authenticated) {
    const setupGoogle = await prompt('Set up Google (Gmail + Calendar)? [Y/n] ');
    if (setupGoogle.toLowerCase() !== 'n') {
      await runSetupGoogle(config);
      config = loadConfig(); // Reload
    }
  } else {
    console.log(`${c.green}âœ“${c.reset} Google already configured: ${status.google.account}\n`);
  }
  
  // Todoist
  if (!status.todoist.working) {
    const setupTodoist = await prompt('Set up Todoist? [Y/n] ');
    if (setupTodoist.toLowerCase() !== 'n') {
      await runSetupTodoist(config);
      config = loadConfig();
    }
  } else {
    console.log(`${c.green}âœ“${c.reset} Todoist already configured\n`);
  }
  
  // GitHub
  if (!status.github.authenticated) {
    const setupGitHub = await prompt('Set up GitHub notifications? (optional) [y/N] ');
    if (setupGitHub.toLowerCase() === 'y') {
      await runSetupGitHub(config);
      config = loadConfig();
    }
  } else {
    console.log(`${c.green}âœ“${c.reset} GitHub already configured: ${status.github.user}\n`);
  }
  
  // Weather
  if (!config.weather?.location) {
    const setupWeather = await prompt('Set weather location? (optional) [y/N] ');
    if (setupWeather.toLowerCase() === 'y') {
      await runSetupWeather(config);
    }
  }
  
  console.log(`\n${c.dim}${'â”€'.repeat(50)}${c.reset}`);
  console.log(`\n${c.green}âœ“${c.reset} Setup complete!\n`);
  console.log(`Run ${c.cyan}mdash${c.reset} to see your dashboard.`);
  console.log(`Run ${c.cyan}mdash gui${c.reset} to open the web interface.\n`);
}

// â”€â”€â”€ Data Fetchers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function fetchEmails(config) {
  if (!config.gmail?.enabled) return [];
  
  const account = config.google?.account;
  const accountFlag = account ? `--account ${account}` : '';
  
  const raw = exec(`gog gmail search '${config.gmail.query}' --max ${config.gmail.maxEmails} ${accountFlag} --json 2>/dev/null`);
  const emails = parseJSON(raw);
  if (!emails || !Array.isArray(emails)) return [];
  
  return emails.map(e => ({
    id: e.id,
    threadId: e.threadId,
    from: e.from?.split('<')[0]?.trim() || e.from || 'Unknown',
    fromFull: e.from || 'Unknown',
    to: e.to,
    subject: e.subject || '(no subject)',
    date: e.date,
    snippet: e.snippet,
    labelIds: e.labelIds || [],
    isUnread: e.labelIds?.includes('UNREAD'),
  }));
}

// Fetch single email details
function fetchEmail(config, emailId) {
  const account = config.google?.account;
  const accountFlag = account ? `--account ${account}` : '';
  
  const raw = exec(`gog gmail read ${emailId} ${accountFlag} --json 2>/dev/null`);
  return parseJSON(raw);
}

// Mark email as read
function markEmailAsRead(config, emailId) {
  const account = config.google?.account;
  const accountFlag = account ? `--account ${account}` : '';
  
  exec(`gog gmail modify ${emailId} --remove-labels UNREAD ${accountFlag} 2>/dev/null`);
  return { success: true };
}

function fetchCalendarEvents(config, options = {}) {
  if (!config.calendar?.enabled) return [];
  
  const account = config.google?.account;
  const accountFlag = account ? `--account ${account}` : '';
  
  // Get events from past 3 days to future 7 days for a better view
  const now = new Date();
  const pastDays = options.pastDays || 3;
  const futureDays = options.futureDays || 7;
  
  const from = new Date(now);
  from.setDate(from.getDate() - pastDays);
  from.setHours(0, 0, 0, 0);
  
  const to = new Date(now);
  to.setDate(to.getDate() + futureDays);
  to.setHours(23, 59, 59, 999);
  
  const raw = exec(`gog calendar events ${config.calendar.id} --from "${from.toISOString()}" --to "${to.toISOString()}" ${accountFlag} --json 2>/dev/null`);
  const events = parseJSON(raw);
  if (!events || !Array.isArray(events)) return [];

  return events
    .map(e => ({
      id: e.id,
      summary: e.summary || '(no title)',
      description: e.description || '',
      start: e.start?.dateTime || e.start?.date,
      end: e.end?.dateTime || e.end?.date,
      location: e.location,
      allDay: !e.start?.dateTime,
      meetLink: e.hangoutLink || e.conferenceData?.entryPoints?.[0]?.uri,
      attendees: e.attendees || [],
      organizer: e.organizer,
      status: e.status,
      htmlLink: e.htmlLink,
    }))
    .sort((a, b) => new Date(a.start) - new Date(b.start));
}

// Fetch single calendar event details
function fetchCalendarEvent(config, eventId) {
  const account = config.google?.account;
  const accountFlag = account ? `--account ${account}` : '';
  
  const raw = exec(`gog calendar event ${config.calendar?.id || 'primary'} ${eventId} ${accountFlag} --json 2>/dev/null`);
  return parseJSON(raw);
}

function fetchTasks(config) {
  if (!config.todoist?.enabled) return { today: [], overdue: [], upcoming: [] };
  
  const token = config.todoist?.apiToken || process.env.TODOIST_API_TOKEN;
  if (!token) return { today: [], overdue: [], upcoming: [] };
  
  // Use direct API calls instead of CLI
  const headers = `-H "Authorization: Bearer ${token}"`;
  const baseUrl = 'https://api.todoist.com/rest/v2';
  
  // Fetch all active tasks
  const raw = exec(`curl -s ${headers} "${baseUrl}/tasks" 2>/dev/null`, { timeout: 10000 });
  const allTasks = parseJSON(raw) || [];
  
  const today = new Date().toISOString().split('T')[0];
  
  const mapTask = (t) => ({
    id: t.id,
    content: t.content,
    description: t.description,
    due: t.due?.string || t.due?.date,
    dueDate: t.due?.date,
    priority: t.priority || 1,
    projectId: t.project_id,
    labels: t.labels || [],
    isOverdue: t.due?.date && t.due.date < today,
    url: todoistTaskUrl(t.url || t.id), // Transform old showTask URLs to new format
  });
  
  const overdue = allTasks
    .filter(t => t.due?.date && t.due.date < today)
    .map(t => mapTask(t));
  
  const todayTasks = allTasks
    .filter(t => t.due?.date === today)
    .map(t => mapTask(t));
  
  const upcoming = config.todoist.showUpcoming 
    ? allTasks
        .filter(t => t.due?.date && t.due.date > today)
        .map(t => mapTask(t))
        .slice(0, 10)
    : [];
  
  return { overdue, today: todayTasks, upcoming };
}

function fetchWeather(config) {
  if (!config.weather?.enabled) return null;
  
  const location = config.weather.location || '';
  
  const raw = exec(`curl -s "wttr.in/${encodeURIComponent(location)}?format=j1" 2>/dev/null`, { timeout: 5000 });
  const data = parseJSON(raw);
  
  if (!data || !data.current_condition?.[0]) return null;
  
  const current = data.current_condition[0];
  const today = data.weather?.[0];
  
  const tempKey = config.weather.units === 'metric' ? 'temp_C' : 'temp_F';
  const feelsKey = config.weather.units === 'metric' ? 'FeelsLikeC' : 'FeelsLikeF';
  const minKey = config.weather.units === 'metric' ? 'mintempC' : 'mintempF';
  const maxKey = config.weather.units === 'metric' ? 'maxtempC' : 'maxtempF';
  const unit = config.weather.units === 'metric' ? 'Â°C' : 'Â°F';
  
  return {
    location: data.nearest_area?.[0]?.areaName?.[0]?.value || location || 'Unknown',
    condition: current.weatherDesc?.[0]?.value || 'Unknown',
    temp: current[tempKey],
    feelsLike: current[feelsKey],
    humidity: current.humidity,
    windSpeed: config.weather.units === 'metric' ? current.windspeedKmph : current.windspeedMiles,
    windUnit: config.weather.units === 'metric' ? 'km/h' : 'mph',
    high: today?.[maxKey],
    low: today?.[minKey],
    unit,
    sunrise: today?.astronomy?.[0]?.sunrise,
    sunset: today?.astronomy?.[0]?.sunset,
    uvIndex: current.uvIndex,
    chanceOfRain: today?.hourly?.[Math.floor(new Date().getHours() / 3)]?.chanceofrain || '0',
  };
}

function fetchGitHubNotifications(config) {
  if (!config.github?.enabled) return [];
  
  const ghCheck = exec('which gh 2>/dev/null');
  if (!ghCheck) return [];
  
  const raw = exec(`gh api notifications --jq '.[] | {id: .id, reason: .reason, title: .subject.title, type: .subject.type, repo: .repository.full_name, unread: .unread}' 2>/dev/null`);
  if (!raw) return [];
  
  return raw.split('\n')
    .filter(line => line.trim())
    .map(line => parseJSON(line))
    .filter(n => n && n.unread)
    .slice(0, config.github.maxNotifications);
}

function fetchSystemHealth(config) {
  if (!config.system?.enabled) return null;
  
  const health = {};
  
  if (config.system.showBattery && process.platform === 'darwin') {
    const batteryRaw = exec('pmset -g batt 2>/dev/null');
    if (batteryRaw) {
      const match = batteryRaw.match(/(\d+)%/);
      const charging = batteryRaw.includes('charging') || batteryRaw.includes('AC Power');
      if (match) {
        health.battery = { percent: parseInt(match[1]), charging };
      }
    }
  }
  
  return Object.keys(health).length > 0 ? health : null;
}

function calculateFocusTime(events, config) {
  if (!config.calendar?.showFocusTime || events.length === 0) return [];
  
  const now = new Date();
  const endOfDay = new Date(now);
  endOfDay.setHours(18, 0, 0, 0);
  
  if (now >= endOfDay) return [];
  
  const todayEvents = events
    .filter(e => !e.allDay && new Date(e.start) >= now && new Date(e.start) < endOfDay)
    .sort((a, b) => new Date(a.start) - new Date(b.start));
  
  const focusBlocks = [];
  let currentTime = new Date(Math.max(now, new Date().setHours(9, 0, 0, 0)));
  
  for (const event of todayEvents) {
    const eventStart = new Date(event.start);
    if (eventStart > currentTime) {
      const duration = (eventStart - currentTime) / 60000;
      if (duration >= 30) {
        focusBlocks.push({ start: new Date(currentTime), end: eventStart, duration });
      }
    }
    currentTime = new Date(Math.max(currentTime, new Date(event.end)));
  }
  
  if (currentTime < endOfDay) {
    const duration = (endOfDay - currentTime) / 60000;
    if (duration >= 30) {
      focusBlocks.push({ start: new Date(currentTime), end: endOfDay, duration });
    }
  }
  
  return focusBlocks.slice(0, 3);
}

// â”€â”€â”€ Native macOS Integrations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const APPLE_CALENDAR_SCRIPT = path.join(os.homedir(), 'clawd/skills/apple-calendar/scripts/cal-events.sh');
const APPLE_MAIL_SCRIPT = path.join(os.homedir(), 'clawd/skills/apple-mail/scripts/mail-list.sh');

function fetchAppleCalendarEvents(config) {
  if (!config.appleCalendar?.enabled) return [];

  const scriptPath = APPLE_CALENDAR_SCRIPT;
  if (!fs.existsSync(scriptPath)) return [];

  const days = config.appleCalendar.lookaheadDays || 7;
  const calendars = config.appleCalendar.calendars || [];

  try {
    let allEvents = [];

    if (calendars.length === 0) {
      // Fetch from all calendars
      const raw = exec(`bash "${scriptPath}" ${days}`, { timeout: 10000 });
      if (raw && !raw.includes('No events found')) {
        allEvents = parseAppleCalendarOutput(raw);
      }
    } else {
      // Fetch from specific calendars
      for (const cal of calendars) {
        const raw = exec(`bash "${scriptPath}" ${days} "${cal}"`, { timeout: 10000 });
        if (raw && !raw.includes('No events found') && !raw.includes('Error:')) {
          allEvents = allEvents.concat(parseAppleCalendarOutput(raw));
        }
      }
    }

    // Sort by start date
    return allEvents.sort((a, b) => new Date(a.start) - new Date(b.start));
  } catch (e) {
    return [];
  }
}

function parseAppleCalendarOutput(raw) {
  if (!raw) return [];
  return raw.trim().split('\n').filter(Boolean).map(line => {
    const parts = line.split(' | ');
    if (parts.length < 5) return null;
    const [uid, summary, start, end, allDay, location, calendar] = parts;
    return {
      id: uid?.trim(),
      title: summary?.trim(),
      start: start?.trim(),
      end: end?.trim(),
      allDay: allDay?.trim() === 'true',
      location: location?.trim() || null,
      calendar: calendar?.trim(),
      source: 'apple',
    };
  }).filter(Boolean);
}

function fetchAppleMailMessages(config) {
  if (!config.appleMail?.enabled) return [];

  const scriptPath = APPLE_MAIL_SCRIPT;
  if (!fs.existsSync(scriptPath)) return [];

  const mailbox = config.appleMail.mailbox || 'INBOX';
  const account = config.appleMail.account || '';
  const limit = config.appleMail.maxEmails || 10;

  try {
    const raw = exec(`bash "${scriptPath}" "${mailbox}" "${account}" ${limit}`, { timeout: 15000 });
    if (!raw) return [];

    return raw.trim().split('\n').filter(Boolean).map(line => {
      const parts = line.split(' | ');
      if (parts.length < 5) return null;
      const [id, readStatus, date, sender, subject] = parts;
      return {
        id: id?.trim(),
        unread: readStatus?.trim() === 'â—',
        date: date?.trim(),
        sender: sender?.trim(),
        subject: subject?.trim(),
        source: 'apple',
      };
    }).filter(Boolean);
  } catch (e) {
    return [];
  }
}

// â”€â”€â”€ Stock Market Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function fetchStockPrices(config) {
  if (!config.stocks?.enabled) return [];

  const symbols = config.stocks.symbols || [];
  if (symbols.length === 0) return [];

  // Write Python script to temp file and execute
  const pythonScript = `
import sys
try:
    import yfinance as yf
    import json
    symbols = sys.argv[1].split(',')
    result = []
    for sym in symbols:
        try:
            ticker = yf.Ticker(sym)
            info = ticker.fast_info
            hist = ticker.history(period='2d')
            if len(hist) >= 2:
                prev_close = hist['Close'].iloc[-2]
                current = hist['Close'].iloc[-1]
                change = ((current - prev_close) / prev_close) * 100
            else:
                current = getattr(info, 'last_price', 0) or 0
                change = 0
            result.append({
                'symbol': sym,
                'price': round(current, 2),
                'change': round(change, 2),
                'currency': getattr(info, 'currency', 'USD') or 'USD',
            })
        except Exception as e:
            result.append({'symbol': sym, 'price': 0, 'change': 0, 'error': str(e)})
    print(json.dumps(result))
except ImportError:
    print('[]')
`;

  try {
    const symbolList = symbols.join(',');
    const scriptPath = '/tmp/mdash_stocks.py';
    fs.writeFileSync(scriptPath, pythonScript);
    const raw = exec(`python3 "${scriptPath}" "${symbolList}"`, { timeout: 30000 });
    return parseJSON(raw) || [];
  } catch (e) {
    return [];
  }
}

// â”€â”€â”€ Expense Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function fetchExpenseSummary(config) {
  if (!config.expenses?.enabled) return null;

  // This integrates with receipt-tracker skill
  // For now, return placeholder - would need Google Sheets API integration
  return {
    enabled: config.expenses.enabled,
    message: 'Configure Google Sheet ID for expense tracking',
  };
}

function fetchAllData(config) {
  const emails = fetchEmails(config);
  const events = fetchCalendarEvents(config);
  const taskData = fetchTasks(config);
  const weather = fetchWeather(config);
  const github = fetchGitHubNotifications(config);
  const systemHealth = fetchSystemHealth(config);
  const focusBlocks = calculateFocusTime(events, config);
  const quote = getDailyQuote();

  // New integrations
  const appleCalendar = fetchAppleCalendarEvents(config);
  const appleMail = fetchAppleMailMessages(config);
  const stocks = fetchStockPrices(config);
  const expenses = fetchExpenseSummary(config);

  return {
    timestamp: new Date().toISOString(),
    greeting: getGreeting(),
    quote,
    tasks: taskData,
    calendar: { events, focusBlocks },
    email: emails,
    weather,
    github,
    system: systemHealth,
    // New integrations
    appleCalendar,
    appleMail,
    stocks,
    expenses,
  };
}

// â”€â”€â”€ Motivational Quotes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const QUOTES = [
  { text: "The secret of getting ahead is getting started.", author: "Mark Twain" },
  { text: "It's not about having time, it's about making time.", author: "Unknown" },
  { text: "Focus on being productive instead of busy.", author: "Tim Ferriss" },
  { text: "The way to get started is to quit talking and begin doing.", author: "Walt Disney" },
  { text: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson" },
  { text: "You don't have to be great to start, but you have to start to be great.", author: "Zig Ziglar" },
  { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
  { text: "Start where you are. Use what you have. Do what you can.", author: "Arthur Ashe" },
  { text: "Small daily improvements are the key to staggering long-term results.", author: "Unknown" },
  { text: "Productivity is never an accident. It is always the result of commitment to excellence.", author: "Paul J. Meyer" },
  { text: "Either you run the day or the day runs you.", author: "Jim Rohn" },
  { text: "Action is the foundational key to all success.", author: "Pablo Picasso" },
  { text: "Done is better than perfect.", author: "Sheryl Sandberg" },
  { text: "The best time to plant a tree was 20 years ago. The second best time is now.", author: "Chinese Proverb" },
  { text: "Until we can manage time, we can manage nothing else.", author: "Peter Drucker" },
];

function getDailyQuote() {
  const now = new Date();
  const start = new Date(now.getFullYear(), 0, 0);
  const diff = now - start;
  const dayOfYear = Math.floor(diff / (1000 * 60 * 60 * 24));
  return QUOTES[dayOfYear % QUOTES.length];
}

// â”€â”€â”€ Terminal Renderers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function box(title, content, color = c.cyan, config) {
  const w = config.display.width;
  const titleText = ` ${title} `;
  const topPad = Math.floor((w - 4 - stripAnsi(titleText).length) / 2);
  const topRemainder = w - 4 - stripAnsi(titleText).length - topPad;

  let output = '';
  output += `${color}â•­${'â”€'.repeat(topPad)}${c.bold}${titleText}${c.reset}${color}${'â”€'.repeat(topRemainder)}â•®${c.reset}\n`;

  const lines = content.split('\n');
  for (const line of lines) {
    const visibleLen = stripAnsi(line).length;
    const padding = Math.max(0, w - 4 - visibleLen);
    output += `${color}â”‚${c.reset} ${line}${' '.repeat(padding)} ${color}â”‚${c.reset}\n`;
  }

  output += `${color}â•°${'â”€'.repeat(w - 2)}â•¯${c.reset}`;
  return output;
}

function divider(config, char = 'â”€') {
  return `${c.dim}${char.repeat(config.display.width)}${c.reset}`;
}

function renderHeader(config, weather, systemHealth) {
  const now = new Date();
  const dateStr = now.toLocaleDateString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
  });
  const timeStr = now.toLocaleTimeString('en-US', {
    hour: 'numeric', minute: '2-digit', hour12: true,
  });

  console.log();
  console.log(`${c.bold}${c.cyan}  â˜€ï¸  ${getGreeting()}!${c.reset}`);
  console.log(`${c.dim}  ${dateStr} â€¢ ${timeStr}${c.reset}`);
  
  if (weather) {
    const icon = getWeatherIcon(weather.condition);
    console.log(`${c.dim}  ${icon} ${weather.temp}${weather.unit} (feels ${weather.feelsLike}${weather.unit}) â€¢ ${weather.condition}${c.reset}`);
  }
  
  if (systemHealth?.battery && systemHealth.battery.percent <= 20 && !systemHealth.battery.charging) {
    console.log(`${c.yellow}  âš ï¸  Battery low: ${systemHealth.battery.percent}%${c.reset}`);
  }
  
  console.log();
  console.log(divider(config, 'â•'));
}

function getWeatherIcon(condition) {
  const cond = (condition || '').toLowerCase();
  if (cond.includes('sun') || cond.includes('clear')) return 'â˜€ï¸';
  if (cond.includes('cloud') && cond.includes('part')) return 'â›…';
  if (cond.includes('cloud') || cond.includes('overcast')) return 'â˜ï¸';
  if (cond.includes('rain') || cond.includes('drizzle')) return 'ðŸŒ§ï¸';
  if (cond.includes('thunder') || cond.includes('storm')) return 'â›ˆï¸';
  if (cond.includes('snow')) return 'ðŸŒ¨ï¸';
  if (cond.includes('fog') || cond.includes('mist')) return 'ðŸŒ«ï¸';
  return 'ðŸŒ¡ï¸';
}

function renderQuote(config) {
  if (!config.quote?.enabled) return;
  const quote = getDailyQuote();
  console.log();
  console.log(`${c.dim}${c.italic}  "${quote.text}"${c.reset}`);
  console.log(`${c.dim}   â€” ${quote.author}${c.reset}`);
}

function renderTasks(taskData, config) {
  const { overdue, today, upcoming } = taskData;
  const allTasks = [...overdue, ...today];
  
  if (allTasks.length === 0 && upcoming.length === 0) {
    console.log(box('ðŸ“‹ TASKS', `${c.dim}No tasks due today. Enjoy your day!${c.reset}`, c.green, config));
    return;
  }

  const lines = [];
  const sorted = allTasks.sort((a, b) => {
    if (a.isOverdue && !b.isOverdue) return -1;
    if (!a.isOverdue && b.isOverdue) return 1;
    return b.priority - a.priority;
  });
  
  for (const task of sorted.slice(0, config.display.maxTasksShown)) {
    const icon = task.priority === 4 ? `${c.red}â—${c.reset}` :
                 task.priority === 3 ? `${c.yellow}â—${c.reset}` :
                 task.priority === 2 ? `${c.blue}â—${c.reset}` : `${c.dim}â—‹${c.reset}`;
    const overdueTag = task.isOverdue ? `${c.red}[OVERDUE]${c.reset} ` : '';
    const dueStr = task.due ? `${c.dim}(${task.due})${c.reset}` : '';
    lines.push(`${icon} ${overdueTag}${truncate(task.content, config.display.width - 16)} ${dueStr}`);
  }
  
  if (allTasks.length > config.display.maxTasksShown) {
    lines.push(`${c.dim}  ... and ${allTasks.length - config.display.maxTasksShown} more tasks${c.reset}`);
  }
  
  if (config.todoist?.showUpcoming && upcoming.length > 0) {
    lines.push('');
    lines.push(`${c.dim}â”€â”€ Upcoming â”€â”€${c.reset}`);
    for (const task of upcoming.slice(0, 3)) {
      lines.push(`${c.dim}  â—‹ ${truncate(task.content, config.display.width - 20)} (${task.due || task.dueDate})${c.reset}`);
    }
  }

  const title = `ðŸ“‹ TASKS (${allTasks.length} today${overdue.length > 0 ? `, ${c.red}${overdue.length} overdue${c.reset}` : ''})`;
  console.log(box(title, lines.join('\n'), c.yellow, config));
}

function renderCalendar(events, focusBlocks, config) {
  if (events.length === 0) {
    console.log(box('ðŸ“… CALENDAR', `${c.dim}No events scheduled for today.${c.reset}`, c.blue, config));
    return;
  }

  const lines = [];
  const now = new Date();
  const nextEvent = events.find(e => !e.allDay && new Date(e.start) > now);
  
  for (const event of events.slice(0, config.display.maxEventsShown)) {
    const isNext = nextEvent && event.id === nextEvent.id;
    const isPast = !event.allDay && new Date(event.end) < now;
    
    let timeStr;
    if (event.allDay) {
      timeStr = `${c.magenta}ALL DAY${c.reset} `;
    } else {
      const time = formatTime(event.start);
      const relative = isNext ? ` ${c.green}â† ${formatRelativeTime(new Date(event.start))}${c.reset}` : '';
      timeStr = `${isPast ? c.dim : c.cyan}${padRight(time, 8)}${c.reset}${relative}`;
    }
    
    lines.push(`${isPast ? c.dim : ''}${timeStr} ${truncate(event.summary, config.display.width - 24)}${c.reset}`);
    
    if (event.location && !config.display.compact) {
      lines.push(`${c.dim}         ðŸ“ ${truncate(event.location, config.display.width - 15)}${c.reset}`);
    }
  }
  
  if (events.length > config.display.maxEventsShown) {
    lines.push(`${c.dim}  ... and ${events.length - config.display.maxEventsShown} more events${c.reset}`);
  }
  
  if (focusBlocks.length > 0 && !config.display.compact) {
    lines.push('');
    lines.push(`${c.green}â”€â”€ Focus Time â”€â”€${c.reset}`);
    for (const block of focusBlocks) {
      const dur = block.duration >= 60 
        ? `${Math.floor(block.duration / 60)}h ${block.duration % 60}m`
        : `${block.duration}m`;
      lines.push(`${c.green}  â—† ${formatTime(block.start.toISOString())} â€” ${dur} available${c.reset}`);
    }
  }

  console.log(box(`ðŸ“… CALENDAR (${events.length})`, lines.join('\n'), c.blue, config));
}

function renderEmails(emails, config) {
  if (emails.length === 0) {
    console.log(box('ðŸ“§ INBOX', `${c.dim}No unread emails. Inbox zero! ðŸŽ‰${c.reset}`, c.magenta, config));
    return;
  }

  const lines = [];
  for (const email of emails.slice(0, config.display.maxEmailsShown)) {
    const from = truncate(email.from, 18);
    const subject = truncate(email.subject, config.display.width - 26);
    lines.push(`${c.cyan}${padRight(from, 18)}${c.reset} ${subject}`);
  }
  
  if (emails.length > config.display.maxEmailsShown) {
    lines.push(`${c.dim}  ... and ${emails.length - config.display.maxEmailsShown} more emails${c.reset}`);
  }

  console.log(box(`ðŸ“§ INBOX (${emails.length} unread)`, lines.join('\n'), c.magenta, config));
}

function renderGitHub(notifications, config) {
  if (notifications.length === 0) return;

  const lines = [];
  const icons = { PullRequest: 'ðŸ”€', Issue: 'ðŸ›', Release: 'ðŸ·ï¸', Discussion: 'ðŸ’¬' };

  for (const n of notifications) {
    const icon = icons[n.type] || 'ðŸ“Œ';
    lines.push(`${icon} ${c.dim}${truncate(n.repo, 20)}${c.reset} ${truncate(n.title, config.display.width - 30)}`);
  }

  console.log(box(`ðŸ™ GITHUB (${notifications.length})`, lines.join('\n'), c.gray, config));
}

function renderStocks(stocks, config) {
  if (!stocks || stocks.length === 0) return;

  const lines = [];
  for (const s of stocks) {
    if (s.error) {
      lines.push(`${c.dim}${s.symbol}: Error${c.reset}`);
      continue;
    }
    const changeColor = s.change >= 0 ? c.green : c.red;
    const changeSign = s.change >= 0 ? '+' : '';
    const arrow = s.change >= 0 ? 'â†‘' : 'â†“';
    lines.push(`${c.bold}${s.symbol}${c.reset}: $${s.price.toFixed(2)} ${changeColor}${arrow} ${changeSign}${s.change.toFixed(2)}%${c.reset}`);
  }

  console.log(box('ðŸ“ˆ STOCKS', lines.join('\n'), c.cyan, config));
}

function renderAppleCalendar(events, config) {
  if (!events || events.length === 0) return;

  const lines = [];
  const today = new Date().toDateString();

  for (const e of events.slice(0, config.display.maxEventsShown || 8)) {
    const startDate = new Date(e.start);
    const isToday = startDate.toDateString() === today;
    const dateStr = isToday ? 'Today' : startDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

    if (e.allDay) {
      lines.push(`${c.dim}${dateStr}${c.reset} ${c.magenta}All Day${c.reset} ${truncate(e.title, config.display.width - 25)}`);
    } else {
      const time = startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      lines.push(`${c.dim}${dateStr}${c.reset} ${c.blue}${time}${c.reset} ${truncate(e.title, config.display.width - 25)}`);
    }
    if (e.location) {
      lines.push(`  ${c.dim}ðŸ“ ${truncate(e.location, config.display.width - 8)}${c.reset}`);
    }
  }

  console.log(box(`ðŸŽ APPLE CALENDAR (${events.length})`, lines.join('\n'), c.magenta, config));
}

function renderAppleMail(emails, config) {
  if (!emails || emails.length === 0) return;

  const unreadCount = emails.filter(e => e.unread).length;
  const lines = [];

  for (const e of emails.slice(0, config.display.maxEmailsShown || 6)) {
    const marker = e.unread ? `${c.cyan}â—${c.reset}` : `${c.dim}â—‹${c.reset}`;
    const sender = truncate(e.sender?.replace(/<.*>/, '').trim() || 'Unknown', 20);
    const subject = truncate(e.subject || '(No Subject)', config.display.width - 28);
    lines.push(`${marker} ${c.dim}${sender}${c.reset} ${subject}`);
  }

  const title = unreadCount > 0 ? `ðŸ“® APPLE MAIL (${unreadCount} unread)` : `ðŸ“® APPLE MAIL`;
  console.log(box(title, lines.join('\n'), c.cyan, config));
}

function renderFooter(stats, config) {
  console.log(divider(config, 'â•'));
  console.log();
  
  const summary = [];
  if (stats.overdueTasks > 0) summary.push(`${c.red}${stats.overdueTasks} overdue${c.reset}`);
  if (stats.todayTasks > 0) summary.push(`${c.yellow}${stats.todayTasks} tasks${c.reset}`);
  if (stats.events > 0) summary.push(`${c.blue}${stats.events} events${c.reset}`);
  if (stats.emails > 0) summary.push(`${c.magenta}${stats.emails} emails${c.reset}`);
  if (stats.github > 0) summary.push(`${c.gray}${stats.github} notifications${c.reset}`);
  
  if (summary.length) {
    console.log(`${c.dim}  Today:${c.reset} ${summary.join(' â€¢ ')}`);
  } else {
    console.log(`${c.green}  âœ¨ All clear! Have a great day.${c.reset}`);
  }
  console.log();
}

// â”€â”€â”€ Web GUI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function generateHTML(data, config, status) {
  const weatherIcon = data.weather ? getWeatherIconEmoji(data.weather.condition) : 'ðŸŒ¡ï¸';
  const showSetup = status && (!status.google.authenticated || !status.todoist.working);
  
  // Calculate totals
  const totalTasks = data.tasks.overdue.length + data.tasks.today.length;
  const totalEvents = data.calendar.events.length;
  const totalEmails = data.email.length;
  const totalGithub = data.github.length;
  const hasAnything = totalTasks > 0 || totalEvents > 0 || totalEmails > 0 || totalGithub > 0;
  
  // Time of day for background
  const hour = new Date().getHours();
  let timeOfDay = 'morning';
  if (hour >= 5 && hour < 12) timeOfDay = 'morning';
  else if (hour >= 12 && hour < 17) timeOfDay = 'noon';
  else if (hour >= 17 && hour < 21) timeOfDay = 'evening';
  else timeOfDay = 'night';
  
  // SVG Icons (Linear-style)
  const icons = {
    tasks: '<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2.5 4.5h11M2.5 8h11M2.5 11.5h7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
    calendar: '<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="2" y="3" width="12" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M2 6h12M5 1.5v3M11 1.5v3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
    mail: '<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1.5" y="3" width="13" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M2 4l6 4 6-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
    github: '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>',
    sun: '<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="3" stroke="currentColor" stroke-width="1.5"/><path d="M8 1v2M8 13v2M1 8h2M13 8h2M3.05 3.05l1.41 1.41M11.54 11.54l1.41 1.41M3.05 12.95l1.41-1.41M11.54 4.46l1.41-1.41" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
    check: '<svg width="14" height="14" viewBox="0 0 14 14" fill="none"><circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/></svg>',
    pr: '<svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M10 9v2.5a1 1 0 01-1 1H5a1 1 0 01-1-1v-7a1 1 0 011-1h4a1 1 0 011 1V7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M7 1.5v4M5 3.5l2-2 2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
    issue: '<svg width="14" height="14" viewBox="0 0 14 14" fill="none"><circle cx="7" cy="7" r="5.5" stroke="currentColor" stroke-width="1.5"/><circle cx="7" cy="7" r="1" fill="currentColor"/></svg>',
  };
  
  // Helper: Render calendar events with date grouping
  const renderCalendarEvents = (events) => {
    if (!events || events.length === 0) return '';
    
    const now = new Date();
    const today = new Date().toDateString();
    const tomorrow = new Date(Date.now() + 86400000).toDateString();
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    
    let lastDate = '';
    let html = '';
    
    events.forEach((e, i) => {
      const eventDate = new Date(e.start).toDateString();
      const isPast = !e.allDay && new Date(e.end) < now;
      const isNext = !isPast && !e.allDay && events.slice(0, i).every(ev => ev.allDay || new Date(ev.end) < now);
      
      // Add date header if new date
      if (eventDate !== lastDate) {
        lastDate = eventDate;
        const d = new Date(e.start);
        let dateLabel;
        if (eventDate === today) dateLabel = 'Today';
        else if (eventDate === tomorrow) dateLabel = 'Tomorrow';
        else if (eventDate === yesterday) dateLabel = 'Yesterday';
        else dateLabel = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        html += '<div class="date-group">' + dateLabel + '</div>';
      }
      
      const eventTime = e.allDay ? 'All day' : formatTimeLong(new Date(e.start));
      
      html += '<div class="list-item clickable" onclick="openEventDetail(\'' + encodeURIComponent(e.id) + '\')">';
      html += '  <div class="event-time ' + (e.allDay ? 'all-day' : '') + ' ' + (isPast ? 'past' : '') + '">' + eventTime + '</div>';
      html += '  <div class="list-item-content">';
      html += '    <div class="list-item-title ' + (isPast ? 'dimmed' : '') + '">' + escapeHtml(e.summary) + '</div>';
      if (e.location) {
        html += '    <div class="list-item-meta">ðŸ“ ' + escapeHtml(e.location) + '</div>';
      }
      html += '  </div>';
      if (isNext) {
        html += '  <span class="list-item-badge list-item-badge-success">Next</span>';
      }
      html += '</div>';
    });
    
    return html;
  };

  return `<!DOCTYPE html>
<html lang="en" class="${timeOfDay}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Morning Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>â˜€ï¸</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    /* Time-based color themes */
    :root {
      /* Morning: 5am - 12pm - Warm peachy tones */
      --morning-bg: rgba(253,242,235,1);
      --morning-secondary: rgba(254,231,212,1);
      --morning-accent: rgba(220,158,114,1);
      
      /* Noon: 12pm - 5pm - Warm orange */
      --noon-bg: rgba(252,222,201,1);
      --noon-secondary: rgba(254,231,212,1);
      --noon-accent: rgba(243,83,102,1);
      
      /* Evening: 5pm - 9pm - Deep orange/salmon */
      --evening-bg: rgba(220,158,114,1);
      --evening-secondary: rgba(252,222,201,1);
      --evening-accent: rgba(97,68,48,1);
      
      /* Night: 9pm - 5am - Dark brown */
      --night-bg: rgba(97,68,48,1);
      --night-secondary: rgba(72,50,35,1);
      --night-accent: rgba(220,158,114,1);
      
      /* Shared colors */
      --lightblue: rgba(140,202,202,1);
      --midblue: rgba(8,91,144,1);
      --darkblue: rgba(16,24,84,1);
      --red: rgba(243,83,102,1);
      --success: rgba(140,202,202,1);
      --warning: rgba(243,83,102,1);
      
      --radius: 12px;
      --radius-lg: 16px;
    }
    
    /* Morning theme */
    html.morning {
      --background: var(--morning-bg);
      --background-secondary: rgba(255,255,255,0.7);
      --background-tertiary: rgba(255,255,255,0.5);
      --border: rgba(0,0,0,0.08);
      --border-hover: rgba(0,0,0,0.12);
      --foreground: rgba(97,68,48,1);
      --foreground-muted: rgba(150,120,100,1);
      --foreground-subtle: rgba(180,150,130,1);
      --accent: var(--midblue);
      --card-shadow: 0 4px 24px rgba(97,68,48,0.1);
    }
    
    /* Noon theme */
    html.noon {
      --background: var(--noon-bg);
      --background-secondary: rgba(255,255,255,0.75);
      --background-tertiary: rgba(255,255,255,0.5);
      --border: rgba(0,0,0,0.08);
      --border-hover: rgba(0,0,0,0.12);
      --foreground: rgba(97,68,48,1);
      --foreground-muted: rgba(140,100,80,1);
      --foreground-subtle: rgba(170,130,110,1);
      --accent: var(--red);
      --card-shadow: 0 4px 24px rgba(97,68,48,0.12);
    }
    
    /* Evening theme */
    html.evening {
      --background: var(--evening-bg);
      --background-secondary: rgba(255,255,255,0.6);
      --background-tertiary: rgba(255,255,255,0.4);
      --border: rgba(0,0,0,0.1);
      --border-hover: rgba(0,0,0,0.15);
      --foreground: rgba(50,35,25,1);
      --foreground-muted: rgba(80,60,45,1);
      --foreground-subtle: rgba(120,90,70,1);
      --accent: var(--darkblue);
      --card-shadow: 0 4px 24px rgba(50,35,25,0.15);
    }
    
    /* Night theme */
    html.night {
      --background: var(--night-bg);
      --background-secondary: rgba(0,0,0,0.3);
      --background-tertiary: rgba(0,0,0,0.2);
      --border: rgba(255,255,255,0.1);
      --border-hover: rgba(255,255,255,0.15);
      --foreground: rgba(254,231,212,1);
      --foreground-muted: rgba(200,180,160,1);
      --foreground-subtle: rgba(160,140,120,1);
      --accent: var(--lightblue);
      --card-shadow: 0 4px 24px rgba(0,0,0,0.3);
    }
    
    html {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body {
      background: var(--background);
      color: var(--foreground);
      line-height: 1.5;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Landscape Background */
    .landscape {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 45vh;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    
    .landscape-layer {
      position: absolute;
      bottom: 0;
      width: 100%;
    }
    
    /* Sun */
    .sun {
      position: absolute;
      border-radius: 50%;
      background: rgba(243,83,102,1);
      transition: all 1s ease;
    }
    
    html.morning .sun {
      width: 80px;
      height: 80px;
      bottom: 30%;
      left: 10%;
      opacity: 0.9;
      box-shadow: 0 0 60px rgba(243,83,102,0.5);
    }
    
    html.noon .sun {
      width: 100px;
      height: 100px;
      bottom: 60%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 1;
      box-shadow: 0 0 80px rgba(243,83,102,0.6);
    }
    
    html.evening .sun {
      width: 90px;
      height: 90px;
      bottom: 20%;
      right: 15%;
      left: auto;
      opacity: 0.85;
      box-shadow: 0 0 100px rgba(243,83,102,0.7);
    }
    
    html.night .sun {
      width: 60px;
      height: 60px;
      bottom: -100px;
      opacity: 0;
    }
    
    /* Mountains - Back Layer */
    .mountains-back {
      height: 35vh;
      background: linear-gradient(135deg, rgba(140,202,202,0.6) 0%, rgba(255,255,255,0.4) 100%);
      clip-path: polygon(
        0% 100%,
        0% 60%,
        5% 55%,
        12% 40%,
        20% 50%,
        28% 35%,
        35% 45%,
        42% 30%,
        50% 42%,
        58% 28%,
        65% 38%,
        72% 25%,
        80% 40%,
        88% 32%,
        95% 45%,
        100% 50%,
        100% 100%
      );
    }
    
    html.night .mountains-back {
      background: linear-gradient(135deg, rgba(16,24,84,0.4) 0%, rgba(8,91,144,0.3) 100%);
    }
    
    /* Mountains - Mid Layer */
    .mountains-mid {
      height: 28vh;
      background: linear-gradient(145deg, rgba(140,202,202,0.8) 0%, rgba(200,230,230,0.6) 50%, rgba(255,255,255,0.5) 100%);
      clip-path: polygon(
        0% 100%,
        0% 70%,
        8% 55%,
        15% 65%,
        25% 45%,
        35% 60%,
        45% 40%,
        55% 55%,
        65% 38%,
        75% 52%,
        85% 42%,
        92% 55%,
        100% 48%,
        100% 100%
      );
      filter: drop-shadow(0 -5px 20px rgba(255,255,255,0.3));
    }
    
    html.night .mountains-mid {
      background: linear-gradient(145deg, rgba(8,91,144,0.5) 0%, rgba(16,24,84,0.4) 100%);
      filter: drop-shadow(0 -5px 15px rgba(0,0,0,0.2));
    }
    
    /* Mountains - Front Layer */
    .mountains-front {
      height: 20vh;
      background: linear-gradient(160deg, rgba(8,91,144,1) 0%, rgba(16,24,84,1) 100%);
      clip-path: polygon(
        0% 100%,
        0% 80%,
        10% 60%,
        20% 75%,
        30% 55%,
        40% 70%,
        50% 50%,
        60% 65%,
        70% 48%,
        80% 62%,
        90% 52%,
        100% 68%,
        100% 100%
      );
    }
    
    html.evening .mountains-front {
      background: linear-gradient(160deg, rgba(8,91,144,0.9) 0%, rgba(16,24,84,0.95) 100%);
    }
    
    html.night .mountains-front {
      background: linear-gradient(160deg, rgba(16,24,84,1) 0%, rgba(8,20,50,1) 100%);
    }
    
    /* Trees */
    .trees {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 18vh;
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      padding: 0 5%;
    }
    
    .tree {
      width: 0;
      height: 0;
      border-style: solid;
      border-color: transparent transparent rgba(16,24,84,1) transparent;
      position: relative;
    }
    
    .tree::before,
    .tree::after {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border-style: solid;
      border-color: transparent transparent rgba(16,24,84,1) transparent;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .tree-1 { border-width: 0 15px 50px 15px; }
    .tree-1::before { border-width: 0 12px 40px 12px; bottom: -35px; }
    .tree-1::after { border-width: 0 9px 30px 9px; bottom: -20px; }
    
    .tree-2 { border-width: 0 20px 65px 20px; }
    .tree-2::before { border-width: 0 16px 52px 16px; bottom: -45px; }
    .tree-2::after { border-width: 0 12px 39px 12px; bottom: -25px; }
    
    .tree-3 { border-width: 0 12px 40px 12px; }
    .tree-3::before { border-width: 0 10px 32px 10px; bottom: -28px; }
    .tree-3::after { border-width: 0 7px 24px 7px; bottom: -16px; }
    
    html.night .tree,
    html.night .tree::before,
    html.night .tree::after {
      border-color: transparent transparent rgba(8,20,50,1) transparent;
    }
    
    .app {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }
    
    /* Header */
    .header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding-bottom: 32px;
      margin-bottom: 32px;
      border-bottom: 1px solid var(--border);
    }
    
    .header-greeting {
      font-size: 32px;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--foreground);
    }
    
    .header-greeting span {
      display: inline-block;
    }
    
    .header-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: var(--foreground-muted);
    }
    
    .header-separator {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--foreground-subtle);
    }
    
    .header-weather {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .header-weather-temp {
      font-weight: 500;
      color: var(--foreground);
    }
    
    /* Setup Banner */
    .banner {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      margin-bottom: 32px;
      background: rgba(245, 158, 11, 0.08);
      border: 1px solid rgba(245, 158, 11, 0.2);
      border-radius: var(--radius-lg);
    }
    
    .banner-icon {
      font-size: 20px;
    }
    
    .banner-content {
      flex: 1;
    }
    
    .banner-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--warning);
      margin-bottom: 2px;
    }
    
    .banner-text {
      font-size: 13px;
      color: var(--foreground-muted);
    }
    
    .banner-text code {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 12px;
      padding: 2px 6px;
      background: var(--background-tertiary);
      border-radius: 4px;
    }
    
    .banner-action {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      color: #000;
      background: var(--warning);
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      text-decoration: none;
      transition: opacity 150ms;
    }
    
    .banner-action:hover {
      opacity: 0.9;
    }
    
    /* Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    
    /* Card */
    .card {
      background: var(--background-secondary);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      transition: border-color 150ms, box-shadow 150ms, transform 150ms;
      box-shadow: var(--card-shadow);
    }
    
    .card:hover {
      border-color: var(--border-hover);
      transform: translateY(-2px);
    }
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 600;
      color: var(--foreground);
    }
    
    .card-title-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: var(--radius);
      background: var(--background-tertiary);
      color: var(--foreground-muted);
    }
    
    .card-badges {
      display: flex;
      gap: 8px;
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: var(--background-tertiary);
      color: var(--foreground-muted);
    }
    
    .badge-accent {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent);
    }
    
    .badge-destructive {
      background: rgba(239, 68, 68, 0.15);
      color: var(--destructive);
    }
    
    .card-body {
      max-height: 380px;
      overflow-y: auto;
    }
    
    .card-body::-webkit-scrollbar {
      width: 6px;
    }
    
    .card-body::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .card-body::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
    
    /* Empty State */
    .empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      text-align: center;
    }
    
    .empty-icon {
      font-size: 32px;
      margin-bottom: 12px;
      opacity: 0.6;
    }
    
    .empty-text {
      font-size: 14px;
      color: var(--foreground-subtle);
    }
    
    /* List Item */
    .list-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      transition: background 100ms;
    }
    
    .list-item:last-child {
      border-bottom: none;
    }
    
    .list-item:hover {
      background: var(--background-tertiary);
    }
    
    .list-item-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      margin-top: 2px;
      flex-shrink: 0;
    }
    
    .list-item-indicator svg {
      width: 14px;
      height: 14px;
    }
    
    .list-item-content {
      flex: 1;
      min-width: 0;
    }
    
    .list-item-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--foreground);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .list-item-title.dimmed {
      color: var(--foreground-subtle);
    }
    
    .list-item-meta {
      font-size: 13px;
      color: var(--foreground-subtle);
      margin-top: 2px;
    }
    
    .list-item-meta a {
      color: var(--accent);
      text-decoration: none;
    }
    
    .list-item-meta a:hover {
      text-decoration: underline;
    }
    
    .list-item-badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      border-radius: 4px;
      flex-shrink: 0;
    }
    
    .list-item-badge-destructive {
      background: rgba(239, 68, 68, 0.12);
      color: var(--destructive);
    }
    
    .list-item-badge-success {
      background: rgba(34, 197, 94, 0.12);
      color: var(--success);
    }
    
    /* Priority */
    .priority-4 { color: var(--destructive); }
    .priority-3 { color: var(--warning); }
    .priority-2 { color: var(--accent); }
    .priority-1 { color: var(--foreground-subtle); }
    
    /* Event */
    .event-time {
      font-size: 13px;
      font-weight: 500;
      color: var(--accent);
      min-width: 72px;
      flex-shrink: 0;
    }
    
    .event-time.all-day {
      color: var(--foreground-muted);
    }
    
    .event-time.past {
      color: var(--foreground-subtle);
    }
    
    /* Focus Section */
    .focus-section {
      padding: 16px 20px;
      background: rgba(34, 197, 94, 0.04);
      border-top: 1px solid var(--border);
    }
    
    .focus-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--success);
      margin-bottom: 12px;
    }
    
    .focus-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--foreground-muted);
      padding: 6px 0;
    }
    
    .focus-item-time {
      font-weight: 500;
      color: var(--success);
    }
    
    /* Weather */
    .weather-content {
      padding: 20px;
    }
    
    .weather-main {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .weather-icon {
      font-size: 40px;
    }
    
    .weather-temp {
      font-size: 32px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    
    .weather-condition {
      font-size: 14px;
      color: var(--foreground-muted);
    }
    
    .weather-details {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 12px;
    }
    
    .weather-detail {
      display: flex;
      gap: 6px;
      padding: 6px 10px;
      background: var(--background-tertiary);
      border-radius: var(--radius);
    }
    
    .weather-detail-label {
      color: var(--foreground-subtle);
    }
    
    .weather-detail-value {
      font-weight: 500;
      color: var(--foreground);
    }
    
    /* Footer */
    .footer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding-top: 32px;
      border-top: 1px solid var(--border);
    }
    
    .summary {
      display: flex;
      gap: 24px;
    }
    
    .summary-item {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }
    
    .summary-count {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    
    .summary-count.destructive { color: var(--destructive); }
    .summary-count.warning { color: var(--warning); }
    .summary-count.accent { color: var(--accent); }
    .summary-count.muted { color: var(--foreground-muted); }
    
    .summary-label {
      font-size: 14px;
      color: var(--foreground-subtle);
    }
    
    .all-clear {
      font-size: 16px;
      color: var(--success);
    }
    
    .footer-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: var(--foreground-subtle);
    }
    
    .refresh-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      color: var(--foreground);
      background: var(--background-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: background 100ms, border-color 100ms;
    }
    
    .refresh-btn:hover {
      background: var(--background-secondary);
      border-color: var(--border-hover);
    }
    
    /* Interactive tasks */
    .list-item-indicator {
      cursor: pointer;
      transition: transform 100ms, opacity 100ms;
    }
    
    .list-item-indicator:hover {
      transform: scale(1.2);
      opacity: 0.8;
    }
    
    .list-item.completing {
      opacity: 0.5;
      pointer-events: none;
    }
    
    .list-item.completed {
      opacity: 0.3;
      text-decoration: line-through;
    }
    
    /* Settings button */
    .settings-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: var(--background-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      color: var(--foreground-muted);
      transition: all 100ms;
    }
    
    .settings-btn:hover {
      background: var(--background-secondary);
      color: var(--foreground);
    }
    
    /* Settings Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay.open {
      display: flex;
    }
    
    .modal {
      background: var(--background-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 480px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 25px 50px rgba(0,0,0,0.25);
    }
    
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .modal-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--foreground-muted);
      border-radius: var(--radius);
      transition: background 100ms;
    }
    
    .modal-close:hover {
      background: var(--background-tertiary);
      color: var(--foreground);
    }
    
    .modal-body {
      padding: 24px;
      overflow-y: auto;
    }
    
    .setting-group {
      margin-bottom: 24px;
    }
    
    .setting-group:last-child {
      margin-bottom: 0;
    }
    
    .setting-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--foreground);
    }
    
    .setting-description {
      font-size: 13px;
      color: var(--foreground-subtle);
      margin-bottom: 12px;
    }
    
    /* Toggle switch */
    .toggle-group {
      display: flex;
      gap: 8px;
    }
    
    .toggle-option {
      flex: 1;
      padding: 10px 16px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      background: var(--background-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 100ms;
      color: var(--foreground-muted);
    }
    
    .toggle-option:hover {
      border-color: var(--border-hover);
    }
    
    .toggle-option.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    /* Input */
    .setting-input {
      width: 100%;
      padding: 10px 14px;
      font-size: 14px;
      background: var(--background-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--foreground);
      outline: none;
      transition: border-color 100ms;
    }
    
    .setting-input:focus {
      border-color: var(--accent);
    }

    /* Settings tabs */
    .settings-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
    }

    .settings-tab {
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 500;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--foreground-muted);
      cursor: pointer;
      transition: all 100ms;
    }

    .settings-tab:hover {
      color: var(--foreground);
    }

    .settings-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .setting-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
      font-size: 14px;
      color: var(--foreground);
    }

    .setting-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .setting-input::placeholder {
      color: var(--foreground-subtle);
    }
    
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--background-secondary);
      border: 1px solid var(--border);
      padding: 12px 20px;
      border-radius: var(--radius);
      font-size: 14px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      z-index: 200;
      opacity: 0;
      transition: all 300ms ease;
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    .toast.success {
      border-color: var(--success);
      color: var(--success);
    }
    
    /* Clickable list items */
    .list-item.clickable {
      cursor: pointer;
    }
    
    .list-item.clickable:hover .list-item-title {
      color: var(--accent);
    }
    
    /* Detail Modal */
    .detail-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      z-index: 150;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .detail-modal.open {
      display: flex;
    }
    
    .detail-content {
      background: var(--background-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 600px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 25px 60px rgba(0,0,0,0.3);
    }
    
    .detail-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }
    
    .detail-title {
      font-size: 18px;
      font-weight: 600;
      line-height: 1.4;
      flex: 1;
    }
    
    .detail-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--foreground-muted);
      border-radius: var(--radius);
      flex-shrink: 0;
    }
    
    .detail-close:hover {
      background: var(--background-tertiary);
      color: var(--foreground);
    }
    
    .detail-body {
      padding: 24px;
      overflow-y: auto;
      max-height: calc(80vh - 80px);
    }
    
    .detail-section {
      margin-bottom: 20px;
    }
    
    .detail-section:last-child {
      margin-bottom: 0;
    }
    
    .detail-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--foreground-subtle);
      margin-bottom: 6px;
    }
    
    .detail-value {
      font-size: 14px;
      color: var(--foreground);
      line-height: 1.6;
    }
    
    .detail-value a {
      color: var(--accent);
      text-decoration: none;
    }
    
    .detail-value a:hover {
      text-decoration: underline;
    }
    
    .detail-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      padding: 16px 0;
      border-top: 1px solid var(--border);
      margin-top: 16px;
    }
    
    .detail-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--foreground-muted);
    }
    
    .detail-actions {
      display: flex;
      gap: 12px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      margin-top: 16px;
    }
    
    .detail-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 100ms;
      border: 1px solid var(--border);
      background: var(--background-tertiary);
      color: var(--foreground);
    }
    
    .detail-btn:hover {
      background: var(--background-secondary);
      border-color: var(--border-hover);
    }
    
    .detail-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    .detail-btn.primary:hover {
      opacity: 0.9;
    }
    
    .detail-btn.success {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    
    /* Email body */
    .email-body {
      font-size: 14px;
      line-height: 1.7;
      color: var(--foreground);
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    /* Loading spinner */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--foreground-muted);
    }
    
    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Date group headers */
    .date-group {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--foreground-subtle);
      padding: 12px 20px 8px;
      background: var(--background-tertiary);
      border-bottom: 1px solid var(--border);
    }
    
    /* Responsive */
    @media (max-width: 840px) {
      .app { padding: 20px 16px; }
      .grid { grid-template-columns: 1fr; }
      .header-greeting { font-size: 24px; }
      .weather-content { grid-template-columns: 1fr; }
      .summary { gap: 16px; }
    }
  </style>
</head>
<body>
  <!-- Landscape Background -->
  <div class="landscape">
    <div class="sun"></div>
    <div class="landscape-layer mountains-back"></div>
    <div class="landscape-layer mountains-mid"></div>
    <div class="landscape-layer mountains-front"></div>
    <div class="trees">
      <div class="tree tree-3"></div>
      <div class="tree tree-1"></div>
      <div class="tree tree-2"></div>
      <div class="tree tree-3"></div>
      <div class="tree tree-1"></div>
      <div class="tree tree-2"></div>
      <div class="tree tree-3"></div>
    </div>
  </div>
  
  <div class="app">
    ${showSetup ? `
    <div class="banner">
      <div class="banner-icon">âš™ï¸</div>
      <div class="banner-content">
        <div class="banner-title">Setup Incomplete</div>
        <div class="banner-text">Run <code>mdash setup</code> to configure integrations</div>
      </div>
      <a href="/setup" class="banner-action">View Status</a>
    </div>
    ` : ''}
    
    <header class="header">
      <div style="display: flex; align-items: center; justify-content: center; gap: 16px;">
        <h1 class="header-greeting"><span>â˜€ï¸</span> ${data.greeting}</h1>
        <button class="settings-btn" onclick="openSettings()" title="Settings">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M9 11.25a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" stroke="currentColor" stroke-width="1.5"/><path d="M14.55 11.25a1.2 1.2 0 00.24 1.32l.04.04a1.46 1.46 0 11-2.06 2.06l-.04-.04a1.2 1.2 0 00-1.32-.24 1.2 1.2 0 00-.73 1.1v.11a1.46 1.46 0 01-2.91 0v-.06a1.2 1.2 0 00-.79-1.1 1.2 1.2 0 00-1.32.24l-.04.04a1.46 1.46 0 11-2.06-2.06l.04-.04a1.2 1.2 0 00.24-1.32 1.2 1.2 0 00-1.1-.73h-.11a1.46 1.46 0 010-2.91h.06a1.2 1.2 0 001.1-.79 1.2 1.2 0 00-.24-1.32l-.04-.04a1.46 1.46 0 112.06-2.06l.04.04a1.2 1.2 0 001.32.24h.06a1.2 1.2 0 00.73-1.1v-.11a1.46 1.46 0 012.91 0v.06a1.2 1.2 0 00.73 1.1 1.2 1.2 0 001.32-.24l.04-.04a1.46 1.46 0 112.06 2.06l-.04.04a1.2 1.2 0 00-.24 1.32v.06a1.2 1.2 0 001.1.73h.11a1.46 1.46 0 010 2.91h-.06a1.2 1.2 0 00-1.1.73z" stroke="currentColor" stroke-width="1.5"/></svg>
        </button>
      </div>
      <div class="header-meta">
        <span>${formatDateLong(new Date())}</span>
        <span class="header-separator"></span>
        <span>${formatTimeLong(new Date())}</span>
        ${data.weather ? `
        <span class="header-separator"></span>
        <span class="header-weather">
          <span>${weatherIcon}</span>
          <span class="header-weather-temp">${data.weather.temp}${data.weather.unit}</span>
          <span>${data.weather.condition}</span>
        </span>
        ` : ''}
      </div>
    </header>
    
    <div class="grid">
      <!-- Tasks -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <div class="card-title-icon">${icons.tasks}</div>
            <span>Tasks</span>
          </div>
          <div class="card-badges">
            ${data.tasks.overdue.length > 0 ? `<span class="badge badge-destructive">${data.tasks.overdue.length} overdue</span>` : ''}
            ${data.tasks.today.length > 0 ? `<span class="badge badge-accent">${data.tasks.today.length} today</span>` : ''}
          </div>
        </div>
        <div class="card-body">
          ${totalTasks === 0 ? `
          <div class="empty">
            <div class="empty-icon">âœ“</div>
            <div class="empty-text">No tasks due today</div>
          </div>
          ` : [...data.tasks.overdue, ...data.tasks.today].map(t => `
          <div class="list-item clickable" id="task-${t.id}" data-task-id="${t.id}">
            <div class="list-item-indicator priority-${t.priority}" onclick="event.stopPropagation(); completeTask('${t.id}')" title="Mark as complete">${icons.check}</div>
            <div class="list-item-content" onclick="openTaskDetail('${t.id}')">
              <div class="list-item-title">${escapeHtml(t.content)}</div>
              ${t.due ? `<div class="list-item-meta">${escapeHtml(t.due)}</div>` : ''}
            </div>
            ${t.isOverdue ? '<span class="list-item-badge list-item-badge-destructive">Overdue</span>' : ''}
          </div>
          `).join('')}
        </div>
      </div>
      
      <!-- Calendar -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <div class="card-title-icon">${icons.calendar}</div>
            <span>Calendar</span>
          </div>
          ${totalEvents > 0 ? `<span class="badge">${totalEvents} events</span>` : ''}
        </div>
        <div class="card-body">
          ${totalEvents === 0 ? `
          <div class="empty">
            <div class="empty-icon">ðŸ“…</div>
            <div class="empty-text">No events scheduled</div>
          </div>
          ` : renderCalendarEvents(data.calendar.events)}
          ${data.calendar.focusBlocks.length > 0 ? `
          <div class="focus-section">
            <div class="focus-header">
              <span>â—†</span>
              <span>Focus Time Available</span>
            </div>
            ${data.calendar.focusBlocks.map(b => `
            <div class="focus-item">
              <span class="focus-item-time">${formatTimeLong(new Date(b.start))}</span>
              <span>â€”</span>
              <span>${formatDuration(b.duration)} available</span>
            </div>
            `).join('')}
          </div>
          ` : ''}
        </div>
      </div>
      
      <!-- Email -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <div class="card-title-icon">${icons.mail}</div>
            <span>Inbox</span>
          </div>
          ${totalEmails > 0 ? `<span class="badge">${totalEmails} unread</span>` : ''}
        </div>
        <div class="card-body">
          ${totalEmails === 0 ? `
          <div class="empty">
            <div class="empty-icon">ðŸ“­</div>
            <div class="empty-text">Inbox zero!</div>
          </div>
          ` : data.email.map(e => `
          <div class="list-item clickable" onclick="openEmailDetail('${e.id}')">
            <div class="list-item-indicator">${icons.mail}</div>
            <div class="list-item-content">
              <div class="list-item-title">${escapeHtml(e.subject)}</div>
              <div class="list-item-meta">${escapeHtml(e.from)}</div>
            </div>
          </div>
          `).join('')}
        </div>
      </div>
      
      <!-- GitHub -->
      ${totalGithub > 0 ? `
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <div class="card-title-icon">${icons.github}</div>
            <span>GitHub</span>
          </div>
          <span class="badge">${totalGithub}</span>
        </div>
        <div class="card-body">
          ${data.github.map(n => `
          <div class="list-item">
            <div class="list-item-indicator">${n.type === 'PullRequest' ? icons.pr : icons.issue}</div>
            <div class="list-item-content">
              <div class="list-item-title">${escapeHtml(n.title)}</div>
              <div class="list-item-meta">${escapeHtml(n.repo)}</div>
            </div>
          </div>
          `).join('')}
        </div>
      </div>
      ` : ''}
      
      <!-- Weather -->
      ${data.weather ? `
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <div class="card-title-icon">${icons.sun}</div>
            <span>Weather</span>
          </div>
          <span class="badge">${data.weather.location}</span>
        </div>
        <div class="weather-content">
          <div class="weather-main">
            <div class="weather-icon">${weatherIcon}</div>
            <div>
              <div class="weather-temp">${data.weather.temp}${data.weather.unit}</div>
              <div class="weather-condition">${data.weather.condition}</div>
            </div>
          </div>
          <div class="weather-details">
            <div class="weather-detail">
              <span class="weather-detail-label">Feels</span>
              <span class="weather-detail-value">${data.weather.feelsLike}Â°</span>
            </div>
            <div class="weather-detail">
              <span class="weather-detail-label">H/L</span>
              <span class="weather-detail-value">${data.weather.high}Â°/${data.weather.low}Â°</span>
            </div>
            <div class="weather-detail">
              <span class="weather-detail-label">Humidity</span>
              <span class="weather-detail-value">${data.weather.humidity}%</span>
            </div>
            <div class="weather-detail">
              <span class="weather-detail-label">Wind</span>
              <span class="weather-detail-value">${data.weather.windSpeed}</span>
            </div>
          </div>
        </div>
      </div>
      ` : ''}

      <!-- Stocks -->
      ${data.stocks && data.stocks.length > 0 ? `
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <div class="card-title-icon">${icons.chart || 'ðŸ“ˆ'}</div>
            <span>Stocks</span>
          </div>
          <span class="badge">${data.stocks.length} symbols</span>
        </div>
        <div class="card-body">
          ${data.stocks.map(s => `
          <div class="list-item">
            <div class="list-item-indicator" style="font-weight: 600;">${escapeHtml(s.symbol)}</div>
            <div class="list-item-content">
              <div class="list-item-title">$${s.price?.toFixed(2) || '0.00'}</div>
              <div class="list-item-meta" style="color: ${(s.change || 0) >= 0 ? 'var(--success)' : 'var(--warning)'}">
                ${(s.change || 0) >= 0 ? 'â†‘' : 'â†“'} ${(s.change || 0) >= 0 ? '+' : ''}${(s.change || 0).toFixed(2)}%
              </div>
            </div>
          </div>
          `).join('')}
        </div>
      </div>
      ` : ''}

      <!-- Apple Calendar -->
      ${data.appleCalendar && data.appleCalendar.length > 0 ? `
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <div class="card-title-icon">ðŸŽ</div>
            <span>Apple Calendar</span>
          </div>
          <span class="badge">${data.appleCalendar.length} events</span>
        </div>
        <div class="card-body">
          ${data.appleCalendar.slice(0, 8).map(e => `
          <div class="list-item">
            <div class="list-item-indicator">${e.allDay ? 'ðŸ“…' : 'ðŸ•'}</div>
            <div class="list-item-content">
              <div class="list-item-title">${escapeHtml(e.title || '')}</div>
              <div class="list-item-meta">${e.allDay ? 'All Day' : escapeHtml(e.start || '')}${e.location ? ' â€¢ ' + escapeHtml(e.location) : ''}</div>
            </div>
          </div>
          `).join('')}
        </div>
      </div>
      ` : ''}

      <!-- Apple Mail -->
      ${data.appleMail && data.appleMail.length > 0 ? `
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <div class="card-title-icon">ðŸ“®</div>
            <span>Apple Mail</span>
          </div>
          <span class="badge">${data.appleMail.filter(e => e.unread).length} unread</span>
        </div>
        <div class="card-body">
          ${data.appleMail.slice(0, 6).map(e => `
          <div class="list-item">
            <div class="list-item-indicator" style="color: ${e.unread ? 'var(--accent)' : 'var(--foreground-subtle)'}">${e.unread ? 'â—' : 'â—‹'}</div>
            <div class="list-item-content">
              <div class="list-item-title">${escapeHtml(e.subject || '(No Subject)')}</div>
              <div class="list-item-meta">${escapeHtml((e.sender || '').replace(/<.*>/, '').trim())}</div>
            </div>
          </div>
          `).join('')}
        </div>
      </div>
      ` : ''}

    </div>

    <footer class="footer">
      ${hasAnything ? `
      <div class="summary">
        ${data.tasks.overdue.length > 0 ? `<div class="summary-item"><span class="summary-count destructive">${data.tasks.overdue.length}</span><span class="summary-label">overdue</span></div>` : ''}
        ${data.tasks.today.length > 0 ? `<div class="summary-item"><span class="summary-count warning">${data.tasks.today.length}</span><span class="summary-label">tasks</span></div>` : ''}
        ${totalEvents > 0 ? `<div class="summary-item"><span class="summary-count accent">${totalEvents}</span><span class="summary-label">events</span></div>` : ''}
        ${totalEmails > 0 ? `<div class="summary-item"><span class="summary-count muted">${totalEmails}</span><span class="summary-label">emails</span></div>` : ''}
        ${totalGithub > 0 ? `<div class="summary-item"><span class="summary-count muted">${totalGithub}</span><span class="summary-label">notifications</span></div>` : ''}
        ${data.stocks && data.stocks.length > 0 ? `<div class="summary-item"><span class="summary-count muted">${data.stocks.length}</span><span class="summary-label">stocks</span></div>` : ''}
      </div>
      ` : `<div class="all-clear">âœ¨ All clear! Have a great day.</div>`}
      <div class="footer-meta">
        <span>Updated ${formatTimeLong(new Date())}</span>
        <button class="refresh-btn" onclick="location.reload()">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M1.5 7a5.5 5.5 0 1 0 1.1-3.3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M1 1v3h3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Refresh
        </button>
      </div>
    </footer>
  </div>
  
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
      <div class="modal" style="max-width: 600px; max-height: 85vh;">
        <div class="modal-header">
          <h2 class="modal-title">Settings</h2>
          <button class="modal-close" onclick="closeSettings()">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M13.5 4.5l-9 9M4.5 4.5l9 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </button>
        </div>
        <div class="settings-tabs">
          <button class="settings-tab active" onclick="switchTab('dashboard')">Dashboard</button>
          <button class="settings-tab" onclick="switchTab('review')">Daily Review</button>
          <button class="settings-tab" onclick="switchTab('integrations')">Integrations</button>
        </div>
        <div class="modal-body" style="overflow-y: auto; max-height: 60vh;">
          <!-- Dashboard Tab -->
          <div id="tab-dashboard" class="tab-content active">
            <div class="setting-group">
              <label class="setting-label">Temperature Units</label>
              <p class="setting-description">Choose between Fahrenheit and Celsius</p>
              <div class="toggle-group">
                <button class="toggle-option ${config.weather?.units === 'imperial' ? 'active' : ''}" onclick="setWeatherUnits('imperial')">Â°F Fahrenheit</button>
                <button class="toggle-option ${config.weather?.units === 'metric' ? 'active' : ''}" onclick="setWeatherUnits('metric')">Â°C Celsius</button>
              </div>
            </div>

            <div class="setting-group">
              <label class="setting-label">Weather Location</label>
              <p class="setting-description">City name, ZIP code, or leave empty for auto-detect</p>
              <input type="text" class="setting-input" id="weatherLocation" placeholder="e.g., New York, 10001, or auto" value="${config.weather?.location || ''}">
              <button style="margin-top: 8px; padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-size: 13px; font-weight: 500;" onclick="saveLocation()">Save Location</button>
            </div>

            <div class="setting-group">
              <label class="setting-label">Auto Refresh</label>
              <p class="setting-description">Automatically refresh data every 5 minutes</p>
              <div class="toggle-group">
                <button class="toggle-option ${config.gui?.autoRefresh !== false ? 'active' : ''}" onclick="setAutoRefresh(true)">On</button>
                <button class="toggle-option ${config.gui?.autoRefresh === false ? 'active' : ''}" onclick="setAutoRefresh(false)">Off</button>
              </div>
            </div>
          </div>

          <!-- Review Tab -->
          <div id="tab-review" class="tab-content">
            <div class="setting-group">
              <label class="setting-label">ðŸ“¬ Communication</label>
              <div class="setting-row"><input type="checkbox" id="r-emails" ${config.review?.emails?.enabled !== false ? 'checked' : ''}><span>Track emails sent (via Google)</span></div>
              <div class="setting-row"><input type="checkbox" id="r-slack" ${config.review?.slack?.enabled ? 'checked' : ''}><span>Track Slack messages</span></div>
              <input type="text" class="setting-input" id="r-slack-path" placeholder="Slack token path" value="${escapeHtml(config.review?.slack?.tokenPath || '')}" style="margin-top: 4px; ${config.review?.slack?.enabled ? '' : 'display:none;'}">
            </div>

            <div class="setting-group">
              <label class="setting-label">ðŸ’» Output</label>
              <p class="setting-description">Git repos folder (auto-scans for repos)</p>
              <input type="text" class="setting-input" id="r-git-folder" placeholder="~/Documents/Development" value="${escapeHtml(config.review?.gitReposFolder || '~/Documents/Development')}">
              <div class="setting-row" style="margin-top: 8px;"><input type="checkbox" id="r-docs" ${config.review?.googleDocs?.enabled !== false ? 'checked' : ''}><span>Track Google Docs modifications</span></div>
            </div>

            <div class="setting-group">
              <label class="setting-label">â±ï¸ Focus Time</label>
              <div class="setting-row"><input type="checkbox" id="r-aw" ${config.review?.activityWatch?.enabled !== false ? 'checked' : ''}><span>ActivityWatch (app tracking)</span></div>
              <div class="setting-row"><input type="checkbox" id="r-screentime" ${config.review?.screenTime?.enabled ? 'checked' : ''}><span>macOS Screen Time</span></div>
            </div>

            <button style="margin-top: 12px; padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-size: 14px; font-weight: 500; width: 100%;" onclick="saveReviewSettings()">Save Review Settings</button>
          </div>

          <!-- Integrations Tab -->
          <div id="tab-integrations" class="tab-content">
            <div class="setting-group">
              <label class="setting-label">Google (Gmail + Calendar)</label>
              <p class="setting-description" style="color: ${status.google.authenticated ? 'var(--success)' : 'var(--warning)'}">
                ${status.google.authenticated ? 'âœ“ Connected: ' + status.google.account : 'â—‹ Not connected'}
              </p>
              ${!status.google.authenticated ? '<p class="setting-description">Run: <code style="background: var(--background-tertiary); padding: 2px 6px; border-radius: 4px;">mdash setup google</code></p>' : ''}
            </div>

            <div class="setting-group">
              <label class="setting-label">Todoist</label>
              <p class="setting-description" style="color: ${status.todoist.working ? 'var(--success)' : 'var(--warning)'}">
                ${status.todoist.working ? 'âœ“ Connected' : 'â—‹ Not configured'}
              </p>
              ${!status.todoist.working ? '<p class="setting-description">Run: <code style="background: var(--background-tertiary); padding: 2px 6px; border-radius: 4px;">mdash setup todoist</code></p>' : ''}
            </div>

            <div class="setting-group">
              <label class="setting-label">GitHub</label>
              <p class="setting-description" style="color: ${status.github.authenticated ? 'var(--success)' : 'var(--foreground-muted)'}">
                ${status.github.authenticated ? 'âœ“ Connected: ' + status.github.user : 'â—‹ Not connected (optional)'}
              </p>
            </div>

            <hr style="border: none; border-top: 1px solid var(--border); margin: 16px 0;">
            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--foreground);">Native macOS Integrations</h3>

            <div class="setting-group">
              <label class="setting-label">Apple Calendar</label>
              <p class="setting-description" style="color: ${config.appleCalendar?.enabled ? 'var(--success)' : 'var(--foreground-muted)'}">
                ${config.appleCalendar?.enabled ? 'âœ“ Enabled' : 'â—‹ Disabled'}
              </p>
              <div class="toggle-group" style="margin-top: 8px;">
                <button class="toggle-option ${config.appleCalendar?.enabled ? 'active' : ''}" onclick="toggleIntegration('appleCalendar', true)">Enable</button>
                <button class="toggle-option ${!config.appleCalendar?.enabled ? 'active' : ''}" onclick="toggleIntegration('appleCalendar', false)">Disable</button>
              </div>
              <p class="setting-description" style="font-size: 11px; margin-top: 6px;">Uses Calendar.app via AppleScript</p>
            </div>

            <div class="setting-group">
              <label class="setting-label">Apple Mail</label>
              <p class="setting-description" style="color: ${config.appleMail?.enabled ? 'var(--success)' : 'var(--foreground-muted)'}">
                ${config.appleMail?.enabled ? 'âœ“ Enabled' : 'â—‹ Disabled'}
              </p>
              <div class="toggle-group" style="margin-top: 8px;">
                <button class="toggle-option ${config.appleMail?.enabled ? 'active' : ''}" onclick="toggleIntegration('appleMail', true)">Enable</button>
                <button class="toggle-option ${!config.appleMail?.enabled ? 'active' : ''}" onclick="toggleIntegration('appleMail', false)">Disable</button>
              </div>
              <p class="setting-description" style="font-size: 11px; margin-top: 6px;">Uses Mail.app via AppleScript</p>
            </div>

            <hr style="border: none; border-top: 1px solid var(--border); margin: 16px 0;">
            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--foreground);">Financial Tracking</h3>

            <div class="setting-group">
              <label class="setting-label">Stock Prices</label>
              <p class="setting-description" style="color: ${config.stocks?.enabled ? 'var(--success)' : 'var(--foreground-muted)'}">
                ${config.stocks?.enabled ? 'âœ“ Tracking: ' + (config.stocks?.symbols || []).join(', ') : 'â—‹ Disabled'}
              </p>
              <div class="toggle-group" style="margin-top: 8px;">
                <button class="toggle-option ${config.stocks?.enabled ? 'active' : ''}" onclick="toggleIntegration('stocks', true)">Enable</button>
                <button class="toggle-option ${!config.stocks?.enabled ? 'active' : ''}" onclick="toggleIntegration('stocks', false)">Disable</button>
              </div>
              ${config.stocks?.enabled ? `
              <div style="margin-top: 8px;">
                <input type="text" id="stockSymbols" value="${(config.stocks?.symbols || []).join(',')}" placeholder="AAPL,MSFT,GOOGL" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--background-tertiary); color: var(--foreground);">
                <button onclick="saveStockSymbols()" style="margin-top: 8px; padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-size: 13px;">Save Symbols</button>
              </div>
              ` : ''}
              <p class="setting-description" style="font-size: 11px; margin-top: 6px;">Uses Yahoo Finance (requires yfinance Python library)</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Detail Modal -->
    <div class="detail-modal" id="detailModal">
      <div class="detail-content">
        <div class="detail-header">
          <h2 class="detail-title" id="detailTitle">Loading...</h2>
          <button class="detail-close" onclick="closeDetail()">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M13.5 4.5l-9 9M4.5 4.5l9 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </button>
        </div>
        <div class="detail-body" id="detailBody">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>
    </div>
    
    <script>
      // Show toast notification
      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast ' + type + ' show';
        setTimeout(() => toast.classList.remove('show'), 3000);
      }
      
      // Detail modal
      function openDetail() {
        document.getElementById('detailModal').classList.add('open');
      }
      
      function closeDetail() {
        document.getElementById('detailModal').classList.remove('open');
      }
      
      // Close on overlay click
      document.getElementById('detailModal').addEventListener('click', (e) => {
        if (e.target.classList.contains('detail-modal')) closeDetail();
      });
      
      // Open task detail
      async function openTaskDetail(taskId) {
        openDetail();
        document.getElementById('detailTitle').textContent = 'Loading...';
        document.getElementById('detailBody').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        
        try {
          const res = await fetch('/api/task/' + taskId);
          const task = await res.json();
          
          if (task.error) {
            document.getElementById('detailBody').innerHTML = '<p>Error loading task</p>';
            return;
          }
          
          document.getElementById('detailTitle').textContent = task.content || 'Task';
          
          const priorityLabels = { 1: 'Low', 2: 'Medium', 3: 'High', 4: 'Urgent' };
          const priorityColors = { 1: 'var(--foreground-subtle)', 2: 'var(--accent)', 3: 'var(--warning)', 4: 'var(--destructive)' };
          
          document.getElementById('detailBody').innerHTML = \`
            \${task.description ? \`
            <div class="detail-section">
              <div class="detail-label">Description</div>
              <div class="detail-value">\${escapeHtmlJS(task.description)}</div>
            </div>
            \` : ''}
            
            <div class="detail-meta">
              \${task.due ? \`<div class="detail-meta-item">ðŸ“… \${task.due.string || task.due.date}</div>\` : ''}
              <div class="detail-meta-item" style="color: \${priorityColors[task.priority] || priorityColors[1]}">â— \${priorityLabels[task.priority] || 'Normal'} priority</div>
              \${task.labels?.length ? \`<div class="detail-meta-item">ðŸ·ï¸ \${task.labels.join(', ')}</div>\` : ''}
            </div>
            
            \${task.comments?.length ? \`
            <div class="detail-section">
              <div class="detail-label">Comments (\${task.comments.length})</div>
              \${task.comments.map(c => \`
                <div style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                  <div class="detail-value">\${escapeHtmlJS(c.content)}</div>
                  <div style="font-size: 12px; color: var(--foreground-subtle); margin-top: 4px;">\${new Date(c.posted_at).toLocaleString()}</div>
                </div>
              \`).join('')}
            </div>
            \` : ''}
            
            <div class="detail-actions">
              <button class="detail-btn success" onclick="completeTaskFromDetail('\${taskId}')">âœ“ Complete</button>
              <a href="https://todoist.com/app/task/\${taskId}" target="_blank" class="detail-btn">Open in Todoist â†’</a>
            </div>
          \`;
        } catch (e) {
          document.getElementById('detailBody').innerHTML = '<p>Error loading task</p>';
        }
      }
      
      async function completeTaskFromDetail(taskId) {
        closeDetail();
        await completeTask(taskId);
      }
      
      // Open event detail
      async function openEventDetail(eventId) {
        openDetail();
        document.getElementById('detailTitle').textContent = 'Loading...';
        document.getElementById('detailBody').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        
        try {
          const res = await fetch('/api/event/' + eventId);
          const event = await res.json();
          
          if (event.error) {
            document.getElementById('detailBody').innerHTML = '<p>Error loading event</p>';
            return;
          }
          
          document.getElementById('detailTitle').textContent = event.summary || 'Event';
          
          const start = new Date(event.start?.dateTime || event.start?.date);
          const end = new Date(event.end?.dateTime || event.end?.date);
          const isAllDay = !event.start?.dateTime;
          
          document.getElementById('detailBody').innerHTML = \`
            \${event.description ? \`
            <div class="detail-section">
              <div class="detail-label">Description</div>
              <div class="detail-value">\${escapeHtmlJS(event.description)}</div>
            </div>
            \` : ''}
            
            <div class="detail-section">
              <div class="detail-label">When</div>
              <div class="detail-value">
                \${isAllDay ? start.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) + ' (All day)' :
                  start.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) + '<br>' +
                  start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) + ' â€“ ' +
                  end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
                }
              </div>
            </div>
            
            \${event.location ? \`
            <div class="detail-section">
              <div class="detail-label">Location</div>
              <div class="detail-value">ðŸ“ \${escapeHtmlJS(event.location)}</div>
            </div>
            \` : ''}
            
            \${event.attendees?.length ? \`
            <div class="detail-section">
              <div class="detail-label">Attendees (\${event.attendees.length})</div>
              <div class="detail-value">\${event.attendees.map(a => a.email + (a.responseStatus === 'accepted' ? ' âœ“' : a.responseStatus === 'declined' ? ' âœ—' : '')).join('<br>')}</div>
            </div>
            \` : ''}
            
            <div class="detail-actions">
              \${event.hangoutLink ? \`<a href="\${event.hangoutLink}" target="_blank" class="detail-btn primary">Join Meeting â†’</a>\` : ''}
              \${event.htmlLink ? \`<a href="\${event.htmlLink}" target="_blank" class="detail-btn">Open in Calendar â†’</a>\` : ''}
            </div>
          \`;
        } catch (e) {
          document.getElementById('detailBody').innerHTML = '<p>Error loading event</p>';
        }
      }
      
      // Open email detail
      async function openEmailDetail(emailId) {
        openDetail();
        document.getElementById('detailTitle').textContent = 'Loading...';
        document.getElementById('detailBody').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        
        try {
          const res = await fetch('/api/email/' + emailId);
          const email = await res.json();
          
          if (email.error) {
            document.getElementById('detailBody').innerHTML = '<p>Error loading email</p>';
            return;
          }
          
          document.getElementById('detailTitle').textContent = email.subject || '(no subject)';
          
          // Mark as read
          fetch('/api/email/read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ emailId })
          });
          
          const date = email.date ? new Date(email.date) : null;
          
          document.getElementById('detailBody').innerHTML = \`
            <div class="detail-section">
              <div class="detail-meta" style="margin-top: 0; padding-top: 0; border-top: none;">
                <div class="detail-meta-item"><strong>From:</strong> \${escapeHtmlJS(email.from || 'Unknown')}</div>
                \${email.to ? \`<div class="detail-meta-item"><strong>To:</strong> \${escapeHtmlJS(email.to)}</div>\` : ''}
                \${date ? \`<div class="detail-meta-item">\${date.toLocaleString()}</div>\` : ''}
              </div>
            </div>
            
            <div class="detail-section">
              <div class="email-body">\${escapeHtmlJS(email.body || email.snippet || 'No content')}</div>
            </div>
            
            <div class="detail-actions">
              <a href="https://mail.google.com/mail/u/0/#inbox/\${emailId}" target="_blank" class="detail-btn primary">Open in Gmail â†’</a>
            </div>
          \`;
        } catch (e) {
          document.getElementById('detailBody').innerHTML = '<p>Error loading email</p>';
        }
      }
      
      // HTML escape for JS
      function escapeHtmlJS(str) {
        if (!str) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/\\n/g, '<br>');
      }
      
      // Complete task
      async function completeTask(taskId) {
        const taskEl = document.getElementById('task-' + taskId);
        if (!taskEl) return;
        
        taskEl.classList.add('completing');
        
        try {
          const res = await fetch('/api/task/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ taskId })
          });
          
          const data = await res.json();
          
          if (data.success) {
            taskEl.classList.remove('completing');
            taskEl.classList.add('completed');
            showToast('Task completed!');
            
            // Remove after animation
            setTimeout(() => {
              taskEl.style.height = taskEl.offsetHeight + 'px';
              taskEl.style.transition = 'all 300ms';
              requestAnimationFrame(() => {
                taskEl.style.height = '0';
                taskEl.style.padding = '0';
                taskEl.style.margin = '0';
                taskEl.style.opacity = '0';
              });
              setTimeout(() => taskEl.remove(), 300);
            }, 500);
          } else {
            taskEl.classList.remove('completing');
            showToast('Failed to complete task', 'error');
          }
        } catch (e) {
          taskEl.classList.remove('completing');
          showToast('Error completing task', 'error');
        }
      }
      
      // Settings modal
      function openSettings() {
        document.getElementById('settingsModal').classList.add('open');
      }
      
      function closeSettings() {
        document.getElementById('settingsModal').classList.remove('open');
      }
      
      // Close modal on overlay click
      document.getElementById('settingsModal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) closeSettings();
      });
      
      // Close modal on Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeSettings();
      });
      
      // Weather units
      async function setWeatherUnits(units) {
        try {
          const res = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ weather: { units } })
          });
          
          if (res.ok) {
            // Update UI
            document.querySelectorAll('.toggle-group').forEach((group, i) => {
              if (i === 0) { // First toggle group is units
                group.querySelectorAll('.toggle-option').forEach(opt => {
                  opt.classList.toggle('active', opt.textContent.includes(units === 'imperial' ? 'Fahrenheit' : 'Celsius'));
                });
              }
            });
            showToast('Settings saved! Refreshing...');
            setTimeout(() => location.reload(), 1000);
          }
        } catch (e) {
          showToast('Failed to save settings', 'error');
        }
      }
      
      // Save location
      async function saveLocation() {
        const location = document.getElementById('weatherLocation').value;
        
        try {
          const res = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ weather: { location } })
          });
          
          if (res.ok) {
            showToast('Location saved! Refreshing...');
            setTimeout(() => location.reload(), 1000);
          }
        } catch (e) {
          showToast('Failed to save location', 'error');
        }
      }
      
      // Auto refresh toggle
      async function setAutoRefresh(enabled) {
        try {
          const res = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ gui: { autoRefresh: enabled } })
          });
          
          if (res.ok) {
            document.querySelectorAll('.toggle-group').forEach((group, i) => {
              if (i === 2) { // Third toggle group is auto-refresh
                group.querySelectorAll('.toggle-option').forEach((opt, j) => {
                  opt.classList.toggle('active', (j === 0) === enabled);
                });
              }
            });
            showToast('Settings saved!');
          }
        } catch (e) {
          showToast('Failed to save settings', 'error');
        }
      }

      // Tab switching
      function switchTab(tabName) {
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelector('.settings-tab[onclick*="' + tabName + '"]').classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('active');
      }

      // Save review settings
      async function saveReviewSettings() {
        const reviewConfig = {
          emails: { enabled: document.getElementById('r-emails').checked },
          slack: {
            enabled: document.getElementById('r-slack').checked,
            tokenPath: document.getElementById('r-slack-path').value.trim()
          },
          xcom: { enabled: false, sshHost: '', birdPath: '' },
          fireflies: { enabled: false, apiKey: '', speakerName: '' },
          gitReposFolder: document.getElementById('r-git-folder').value.trim() || '~/Documents/Development',
          googleDocs: { enabled: document.getElementById('r-docs').checked },
          activityWatch: { enabled: document.getElementById('r-aw').checked },
          screenTime: {
            enabled: document.getElementById('r-screentime').checked,
            sshHost: '',
            scriptPath: '~/get_screentime.py'
          }
        };

        try {
          const res = await fetch('/api/review-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(reviewConfig)
          });
          if (res.ok) {
            showToast('Review settings saved!');
          } else {
            showToast('Failed to save settings', 'error');
          }
        } catch (e) {
          showToast('Failed to save: ' + e.message, 'error');
        }
      }

      // Toggle slack path visibility
      document.getElementById('r-slack')?.addEventListener('change', (e) => {
        document.getElementById('r-slack-path').style.display = e.target.checked ? 'block' : 'none';
      });

      // Toggle integration on/off
      async function toggleIntegration(name, enabled) {
        try {
          const body = {};
          body[name] = { enabled };
          const res = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          if (res.ok) {
            showToast(name + ' ' + (enabled ? 'enabled' : 'disabled') + '! Refreshing...');
            setTimeout(() => location.reload(), 1000);
          }
        } catch (e) {
          showToast('Failed to toggle integration', 'error');
        }
      }

      // Save stock symbols
      async function saveStockSymbols() {
        const symbolsInput = document.getElementById('stockSymbols');
        if (!symbolsInput) return;
        const symbols = symbolsInput.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
        try {
          const res = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stocks: { symbols } })
          });
          if (res.ok) {
            showToast('Stock symbols saved! Refreshing...');
            setTimeout(() => location.reload(), 1000);
          }
        } catch (e) {
          showToast('Failed to save symbols', 'error');
        }
      }

      ${config.gui?.autoRefresh !== false ? `setTimeout(() => location.reload(), ${(config.gui?.refreshInterval || 300) * 1000});` : ''}
    </script>
</body>
</html>`;
}

function generateSetupHTML(status, config) {
  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Setup - Morning Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš™ï¸</text></svg>">
  <style>
    :root { --bg: #0d1117; --bg-card: #161b22; --bg-hover: #21262d; --border: #30363d; --text: #e6edf3; --text-muted: #8b949e; --accent: #58a6ff; --green: #3fb950; --yellow: #d29922; --red: #f85149; }
    @media (prefers-color-scheme: light) { :root { --bg: #f6f8fa; --bg-card: #ffffff; --bg-hover: #f3f4f6; --border: #d0d7de; --text: #1f2328; --text-muted: #656d76; --accent: #0969da; --green: #1a7f37; --yellow: #9a6700; --red: #cf222e; } }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; padding: 2rem; }
    .container { max-width: 700px; margin: 0 auto; }
    h1 { font-size: 1.75rem; margin-bottom: 0.5rem; }
    .subtitle { color: var(--text-muted); margin-bottom: 2rem; }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; }
    .card-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
    .card-title { font-weight: 600; font-size: 1.1rem; }
    .status { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; padding: 0.25rem 0.75rem; border-radius: 20px; }
    .status.ok { background: rgba(63, 185, 80, 0.15); color: var(--green); }
    .status.warn { background: rgba(210, 153, 34, 0.15); color: var(--yellow); }
    .status.err { background: rgba(248, 81, 73, 0.15); color: var(--red); }
    .detail { font-size: 0.9rem; color: var(--text-muted); margin-top: 0.5rem; }
    code { background: var(--bg-hover); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.85rem; }
    .back-link { display: inline-block; margin-top: 2rem; color: var(--accent); text-decoration: none; }
    .back-link:hover { text-decoration: underline; }
    .setting { margin: 0.75rem 0; }
    .setting label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
    .setting input[type="checkbox"] { width: 1.1rem; height: 1.1rem; accent-color: var(--accent); }
  </style>
</head>
<body>
  <div class="container">
    <h1>âš™ï¸ Setup Status</h1>
    <p class="subtitle">Run <code>mdash setup</code> in terminal to configure</p>
    
    <div class="card">
      <div class="card-header">
        <span class="card-title">Google (Gmail + Calendar)</span>
        <span class="status ${status.google.authenticated ? 'ok' : status.google.installed ? 'warn' : 'err'}">
          ${status.google.authenticated ? 'âœ“ Connected' : status.google.installed ? 'â—‹ Not authenticated' : 'âœ— Not installed'}
        </span>
      </div>
      ${status.google.authenticated ? `<div class="detail">Account: ${status.google.account}<br>Services: ${status.google.services.join(', ')}</div>` : 
        status.google.installed ? `<div class="detail">Run: <code>mdash setup google</code></div>` : 
        `<div class="detail">Install: <code>brew install steipete/tap/gogcli</code></div>`}
    </div>
    
    <div class="card">
      <div class="card-header">
        <span class="card-title">Todoist</span>
        <span class="status ${status.todoist.working ? 'ok' : status.todoist.configured ? 'err' : 'warn'}">
          ${status.todoist.working ? 'âœ“ Connected' : status.todoist.configured ? 'âœ— Token invalid' : 'â—‹ Not configured'}
        </span>
      </div>
      <div class="detail">${status.todoist.working ? 'API token verified' : 'Run: <code>mdash setup todoist</code>'}</div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <span class="card-title">GitHub</span>
        <span class="status ${status.github.authenticated ? 'ok' : status.github.installed ? 'warn' : 'warn'}">
          ${status.github.authenticated ? 'âœ“ Connected' : status.github.installed ? 'â—‹ Not authenticated' : 'â—‹ Not installed (optional)'}
        </span>
      </div>
      <div class="detail">${status.github.authenticated ? `Logged in as: ${status.github.user}` : status.github.installed ? 'Run: <code>mdash setup github</code>' : 'Install: <code>brew install gh</code>'}</div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <span class="card-title">Weather</span>
        <span class="status ok">âœ“ Available</span>
      </div>
      <div class="detail">Location: ${status.weather.location || 'Auto-detect by IP'}</div>
    </div>

    <h2 style="margin: 2rem 0 1rem; font-size: 1.25rem;">ðŸ† Daily Review Settings</h2>

    <div class="card">
      <div class="card-header">
        <span class="card-title">Communication Tracking</span>
      </div>
      <div class="setting">
        <label><input type="checkbox" id="review-emails" ${config.review?.emails?.enabled !== false ? 'checked' : ''}> Emails (via Google)</label>
      </div>
      <div class="setting">
        <label><input type="checkbox" id="review-slack" ${config.review?.slack?.enabled ? 'checked' : ''}> Slack Messages</label>
        <input type="text" id="review-slack-path" placeholder="Token path (e.g., ~/secrets/slack.json)" value="${escapeHtml(config.review?.slack?.tokenPath || '')}" style="margin-top: 0.5rem; width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
      </div>
      <div class="setting">
        <label><input type="checkbox" id="review-xcom" ${config.review?.xcom?.enabled ? 'checked' : ''}> X.com / Twitter</label>
        <input type="text" id="review-xcom-ssh" placeholder="SSH host (leave empty for local)" value="${escapeHtml(config.review?.xcom?.sshHost || '')}" style="margin-top: 0.5rem; width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">Meetings (Fireflies)</span>
      </div>
      <div class="setting">
        <label><input type="checkbox" id="review-fireflies" ${config.review?.fireflies?.enabled ? 'checked' : ''}> Enable Fireflies</label>
        <input type="text" id="review-fireflies-key" placeholder="API Key" value="${escapeHtml(config.review?.fireflies?.apiKey || '')}" style="margin-top: 0.5rem; width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
        <input type="text" id="review-fireflies-name" placeholder="Your name (for speaker verification)" value="${escapeHtml(config.review?.fireflies?.speakerName || '')}" style="margin-top: 0.5rem; width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">Output Tracking</span>
      </div>
      <div class="setting">
        <label><input type="checkbox" id="review-docs" ${config.review?.googleDocs?.enabled !== false ? 'checked' : ''}> Google Docs</label>
      </div>
      <div class="setting">
        <label>Git Repos Folder (auto-scans for repos):</label>
        <input type="text" id="review-git-folder" placeholder="~/Documents/Development" value="${escapeHtml(config.review?.gitReposFolder || '~/Documents/Development')}" style="margin-top: 0.5rem; width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-family: monospace;">
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">Focus Time</span>
      </div>
      <div class="setting">
        <label><input type="checkbox" id="review-aw" ${config.review?.activityWatch?.enabled !== false ? 'checked' : ''}> ActivityWatch</label>
      </div>
      <div class="setting">
        <label><input type="checkbox" id="review-screentime" ${config.review?.screenTime?.enabled ? 'checked' : ''}> macOS Screen Time</label>
        <input type="text" id="review-screentime-ssh" placeholder="SSH host (leave empty for local)" value="${escapeHtml(config.review?.screenTime?.sshHost || '')}" style="margin-top: 0.5rem; width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
      </div>
    </div>

    <button id="save-review" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer;">Save Review Settings</button>
    <span id="save-status" style="margin-left: 1rem; color: var(--green); display: none;">âœ“ Saved!</span>

    <script>
      document.getElementById('save-review').addEventListener('click', async () => {
        const reviewConfig = {
          emails: { enabled: document.getElementById('review-emails').checked },
          slack: {
            enabled: document.getElementById('review-slack').checked,
            tokenPath: document.getElementById('review-slack-path').value.trim()
          },
          xcom: {
            enabled: document.getElementById('review-xcom').checked,
            sshHost: document.getElementById('review-xcom-ssh').value.trim(),
            birdPath: '~/Code/bird'
          },
          fireflies: {
            enabled: document.getElementById('review-fireflies').checked,
            apiKey: document.getElementById('review-fireflies-key').value.trim(),
            speakerName: document.getElementById('review-fireflies-name').value.trim()
          },
          googleDocs: { enabled: document.getElementById('review-docs').checked },
          gitReposFolder: document.getElementById('review-git-folder').value.trim() || '~/Documents/Development',
          activityWatch: { enabled: document.getElementById('review-aw').checked },
          screenTime: {
            enabled: document.getElementById('review-screentime').checked,
            sshHost: document.getElementById('review-screentime-ssh').value.trim(),
            scriptPath: '~/get_screentime.py'
          }
        };

        try {
          const res = await fetch('/api/review-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(reviewConfig)
          });
          const result = await res.json();
          if (result.success) {
            const status = document.getElementById('save-status');
            status.style.display = 'inline';
            setTimeout(() => status.style.display = 'none', 2000);
          }
        } catch (e) {
          alert('Failed to save: ' + e.message);
        }
      });
    </script>

    <a href="/" class="back-link">â† Back to Dashboard</a>
  </div>
</body>
</html>`;
}

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function formatDateLong(date) {
  return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}

function formatTimeLong(date) {
  return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
}

function formatDuration(minutes) {
  if (minutes >= 60) {
    const h = Math.floor(minutes / 60), m = minutes % 60;
    return m > 0 ? `${h}h ${m}m` : `${h}h`;
  }
  return `${minutes}m`;
}

function getWeatherIconEmoji(condition) {
  const cond = (condition || '').toLowerCase();
  if (cond.includes('sun') || cond.includes('clear')) return 'â˜€ï¸';
  if (cond.includes('cloud') && cond.includes('part')) return 'â›…';
  if (cond.includes('cloud') || cond.includes('overcast')) return 'â˜ï¸';
  if (cond.includes('rain')) return 'ðŸŒ§ï¸';
  if (cond.includes('snow')) return 'ðŸŒ¨ï¸';
  return 'ðŸŒ¡ï¸';
}

function startGUIServer(config, port) {
  // Helper to parse POST body
  const parseBody = (req) => new Promise((resolve) => {
    let body = '';
    req.on('data', chunk => body += chunk);
    req.on('end', () => {
      try { resolve(JSON.parse(body)); } catch { resolve({}); }
    });
  });
  
  // Helper to complete a task via Todoist API
  const completeTask = async (taskId) => {
    const token = config.todoist?.apiToken || process.env.TODOIST_API_TOKEN;
    if (!token) return { success: false, error: 'No API token' };
    
    const result = exec(`curl -s -X POST -H "Authorization: Bearer ${token}" "https://api.todoist.com/rest/v2/tasks/${taskId}/close" 2>/dev/null`);
    return { success: true };
  };
  
  const server = http.createServer(async (req, res) => {
    const status = getIntegrationStatus(config);
    
    // CORS headers for all requests
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    
    if (req.method === 'OPTIONS') {
      res.writeHead(204);
      res.end();
      return;
    }
    
    // API: Get data
    if (req.url === '/api/data' && req.method === 'GET') {
      res.setHeader('Content-Type', 'application/json');
      const data = fetchAllData(config);
      res.end(JSON.stringify({ ...data, status, config: { weather: config.weather } }));
    }
    // API: Get status
    else if (req.url === '/api/status' && req.method === 'GET') {
      res.setHeader('Content-Type', 'application/json');
      res.end(JSON.stringify(status));
    }
    // API: Get settings
    else if (req.url === '/api/settings' && req.method === 'GET') {
      res.setHeader('Content-Type', 'application/json');
      res.end(JSON.stringify({
        weather: config.weather || {},
        display: config.display || {},
      }));
    }
    // API: Save settings
    else if (req.url === '/api/settings' && req.method === 'POST') {
      res.setHeader('Content-Type', 'application/json');
      const body = await parseBody(req);
      
      // Update config
      if (body.weather) {
        config.weather = { ...config.weather, ...body.weather };
      }
      if (body.display) {
        config.display = { ...config.display, ...body.display };
      }
      if (body.gui) {
        config.gui = { ...config.gui, ...body.gui };
      }
      
      // Save to file
      saveConfig(config);
      
      res.end(JSON.stringify({ success: true, config: { weather: config.weather, display: config.display, gui: config.gui } }));
    }
    // API: Complete task
    else if (req.url === '/api/task/complete' && req.method === 'POST') {
      res.setHeader('Content-Type', 'application/json');
      const body = await parseBody(req);
      
      if (!body.taskId) {
        res.end(JSON.stringify({ success: false, error: 'Missing taskId' }));
        return;
      }
      
      const result = await completeTask(body.taskId);
      res.end(JSON.stringify(result));
    }
    // API: Reopen task
    else if (req.url === '/api/task/reopen' && req.method === 'POST') {
      res.setHeader('Content-Type', 'application/json');
      const body = await parseBody(req);
      const token = config.todoist?.apiToken || process.env.TODOIST_API_TOKEN;
      
      if (!body.taskId || !token) {
        res.end(JSON.stringify({ success: false, error: 'Missing taskId or token' }));
        return;
      }
      
      exec(`curl -s -X POST -H "Authorization: Bearer ${token}" "https://api.todoist.com/rest/v2/tasks/${body.taskId}/reopen" 2>/dev/null`);
      res.end(JSON.stringify({ success: true }));
    }
    // API: Get single task details
    else if (req.url.startsWith('/api/task/') && req.method === 'GET') {
      res.setHeader('Content-Type', 'application/json');
      const taskId = req.url.split('/api/task/')[1];
      const token = config.todoist?.apiToken || process.env.TODOIST_API_TOKEN;
      
      if (!token) {
        res.end(JSON.stringify({ error: 'No API token' }));
        return;
      }
      
      const raw = exec(`curl -s -H "Authorization: Bearer ${token}" "https://api.todoist.com/rest/v2/tasks/${taskId}" 2>/dev/null`);
      const task = parseJSON(raw);
      
      // Also get comments
      const commentsRaw = exec(`curl -s -H "Authorization: Bearer ${token}" "https://api.todoist.com/rest/v2/comments?task_id=${taskId}" 2>/dev/null`);
      const comments = parseJSON(commentsRaw) || [];
      
      res.end(JSON.stringify({ ...task, comments }));
    }
    // API: Get calendar event details
    else if (req.url.startsWith('/api/event/') && req.method === 'GET') {
      res.setHeader('Content-Type', 'application/json');
      const eventId = decodeURIComponent(req.url.split('/api/event/')[1]);
      const event = fetchCalendarEvent(config, eventId);
      res.end(JSON.stringify(event || { error: 'Event not found' }));
    }
    // API: Get email details
    else if (req.url.startsWith('/api/email/') && req.method === 'GET') {
      res.setHeader('Content-Type', 'application/json');
      const emailId = req.url.split('/api/email/')[1];
      const email = fetchEmail(config, emailId);
      res.end(JSON.stringify(email || { error: 'Email not found' }));
    }
    // API: Mark email as read
    else if (req.url === '/api/email/read' && req.method === 'POST') {
      res.setHeader('Content-Type', 'application/json');
      const body = await parseBody(req);
      
      if (!body.emailId) {
        res.end(JSON.stringify({ success: false, error: 'Missing emailId' }));
        return;
      }
      
      const result = markEmailAsRead(config, body.emailId);
      res.end(JSON.stringify(result));
    }
    // API: Save review config
    else if (req.url === '/api/review-config' && req.method === 'POST') {
      res.setHeader('Content-Type', 'application/json');
      const body = await parseBody(req);

      // Update config with new review settings
      config.review = body;
      saveConfig(config);

      res.end(JSON.stringify({ success: true }));
    }
    // Setup page
    else if (req.url === '/setup') {
      res.setHeader('Content-Type', 'text/html');
      res.end(generateSetupHTML(status, config));
    }
    // Main dashboard
    else {
      res.setHeader('Content-Type', 'text/html');
      const data = fetchAllData(config);
      res.end(generateHTML(data, config, status));
    }
  });
  
  server.listen(port, '127.0.0.1', () => {
    const url = `http://localhost:${port}`;
    console.log(`\nâ˜€ï¸  Morning Dashboard GUI`);
    console.log(`${'â”€'.repeat(40)}`);
    console.log(`Dashboard:  ${url}`);
    console.log(`Setup:      ${url}/setup`);
    console.log(`API:        ${url}/api/data`);
    console.log(`\nPress Ctrl+C to stop\n`);
    
    const openCmd = process.platform === 'darwin' ? 'open' : process.platform === 'win32' ? 'start' : 'xdg-open';
    try { spawn(openCmd, [url], { detached: true, stdio: 'ignore' }).unref(); } catch (e) {}
  });
  
  server.on('error', (e) => {
    if (e.code === 'EADDRINUSE') {
      console.error(`\nError: Port ${port} in use. Try: mdash gui --port ${port + 1}\n`);
      process.exit(1);
    }
    throw e;
  });
}

// â”€â”€â”€ Daily Review â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function runDailyReview(date, config) {
  const reviewDate = date || new Date().toISOString().split('T')[0];
  const reviewConfig = config.review || {};

  console.log(`\n${c.bold}ðŸ† Daily Performance Review - ${reviewDate}${c.reset}`);
  console.log(`${c.dim}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${c.reset}\n`);

  // Calculate next date (for date range queries)
  const dateObj = new Date(reviewDate);
  const nextDate = new Date(dateObj);
  nextDate.setDate(nextDate.getDate() + 1);
  const dateNext = nextDate.toISOString().split('T')[0];

  // ============ COMMUNICATION ============
  console.log(`${c.bold}ðŸ“¬ COMMUNICATION${c.reset}`);

  // Emails sent (using gog if available)
  if (reviewConfig.emails?.enabled !== false) {
    let emails = '?';
    const googleCheck = checkGoogleSetup(config);
    if (googleCheck.installed && googleCheck.authenticated && googleCheck.hasGmail) {
      const account = googleCheck.account;
      const query = `after:${reviewDate.replace(/-/g, '/')} before:${dateNext.replace(/-/g, '/')} from:me`;
      const raw = exec(`gog gmail search "${account}" "${query}" --json 2>/dev/null`, { timeout: 10000 });
      const data = parseJSON(raw);
      emails = Array.isArray(data) ? data.length : '?';
    }
    console.log(`  ${c.dim}â€¢${c.reset} Emails sent: ${emails}`);
  }

  // Slack messages
  if (reviewConfig.slack?.enabled) {
    let slackMsgs = '?';
    const slackTokenPath = reviewConfig.slack.tokenPath?.replace(/^~/, os.homedir()) || '';
    if (slackTokenPath && fs.existsSync(slackTokenPath)) {
      try {
        const slackConfig = JSON.parse(fs.readFileSync(slackTokenPath, 'utf-8'));
        const slackToken = slackConfig.user_token;
        if (slackToken) {
          const raw = exec(`curl -s "https://slack.com/api/search.messages" -H "Authorization: Bearer ${slackToken}" -G --data-urlencode "query=from:me on:${reviewDate}" --data-urlencode "count=1" 2>/dev/null`, { timeout: 10000 });
          const data = parseJSON(raw);
          slackMsgs = data?.messages?.total ?? '?';
        }
      } catch (e) { /* ignore */ }
    }
    console.log(`  ${c.dim}â€¢${c.reset} Slack messages: ${slackMsgs}`);
  }

  // X.com mentions (via bird)
  if (reviewConfig.xcom?.enabled) {
    let xcom = '?';
    const sshHost = reviewConfig.xcom.sshHost || '';
    const birdPath = reviewConfig.xcom.birdPath || '~/Code/bird';
    let cmd;
    if (sshHost) {
      cmd = `ssh -o ConnectTimeout=5 -o BatchMode=yes ${sshHost} "cd ${birdPath} && node dist/cli.js mentions -n 50 2>/dev/null | grep -c '@' || echo 0" 2>/dev/null`;
    } else {
      const localBirdPath = birdPath.replace(/^~/, os.homedir());
      cmd = `cd "${localBirdPath}" && node dist/cli.js mentions -n 50 2>/dev/null | grep -c '@' || echo 0`;
    }
    const birdResult = exec(cmd, { timeout: 15000 });
    if (birdResult !== null) xcom = birdResult;
    console.log(`  ${c.dim}â€¢${c.reset} X.com mentions: ${xcom}`);
  }

  console.log();

  // ============ MEETINGS ============
  if (reviewConfig.fireflies?.enabled) {
    console.log(`${c.bold}ðŸ“… MEETINGS${c.reset} ${c.dim}(Fireflies - speaker verified)${c.reset}`);

    let meetings = [];
    const firefliesKey = reviewConfig.fireflies.apiKey || '';
    const speakerName = (reviewConfig.fireflies.speakerName || '').toLowerCase();

    if (firefliesKey) {
      try {
        const query = '{ transcripts(limit: 30) { title dateString duration sentences { speaker_name } } }';
        const raw = exec(`curl -s -X POST "https://api.fireflies.ai/graphql" -H "Authorization: Bearer ${firefliesKey}" -H "Content-Type: application/json" -d '{"query": "${query}"}' 2>/dev/null`, { timeout: 15000 });
        const data = parseJSON(raw);
        if (data?.data?.transcripts) {
          meetings = data.data.transcripts
            .filter(t => t.dateString && t.dateString.startsWith(reviewDate))
            .filter(t => {
              if (!speakerName) return true;
              const speakers = (t.sentences || []).map(s => (s.speaker_name || '').toLowerCase());
              return speakers.some(s => s.includes(speakerName));
            })
            .map(t => ({ title: t.title.replace('Meet â€“ ', ''), duration: Math.floor(t.duration) }));
          meetings = [...new Map(meetings.map(m => [m.title, m])).values()];
        }
      } catch (e) { /* ignore */ }
    }

    if (meetings.length > 0) {
      meetings.forEach(m => console.log(`  ${c.dim}â€¢${c.reset} ${m.title} (${m.duration} min)`));
      const totalMins = meetings.reduce((sum, m) => sum + m.duration, 0);
      const totalHrs = (totalMins / 60).toFixed(1);
      console.log(`  ${c.dim}Total: ${meetings.length} meetings (~${totalHrs} hrs)${c.reset}`);
    } else {
      console.log(`  ${c.dim}â€¢ No meetings found${c.reset}`);
    }

    console.log();
  }

  // ============ OUTPUT ============
  console.log(`${c.bold}ðŸ’» OUTPUT${c.reset}`);

  // Git commits - scan folder for repos
  let gitCommits = 0;
  const gitFolder = (reviewConfig.gitReposFolder || '~/Documents/Development').replace(/^~/, os.homedir());

  // Find all git repos in the folder (max depth 2)
  const findReposCmd = `find "${gitFolder}" -maxdepth 2 -type d -name ".git" 2>/dev/null | head -50`;
  const gitDirs = exec(findReposCmd, { timeout: 10000 });

  if (gitDirs) {
    const repos = gitDirs.split('\n').filter(d => d).map(d => path.dirname(d));
    for (const repo of repos) {
      const count = exec(`cd "${repo}" && git log --oneline --since="${reviewDate} 00:00" --until="${dateNext} 00:00" 2>/dev/null | wc -l`, { timeout: 5000 });
      if (count) gitCommits += parseInt(count.trim(), 10) || 0;
    }
  }
  console.log(`  ${c.dim}â€¢${c.reset} Git commits: ${gitCommits}`);

  // Google Docs edited
  if (reviewConfig.googleDocs?.enabled !== false) {
    let docs = '?';
    const googleCheck = checkGoogleSetup(config);
    if (googleCheck.installed && googleCheck.authenticated) {
      const account = googleCheck.account;
      const raw = exec(`gog drive list "${account}" --query "modifiedTime>='${reviewDate}T00:00:00'" --json 2>/dev/null`, { timeout: 10000 });
      const data = parseJSON(raw);
      docs = Array.isArray(data) ? data.length : '?';
    }
    console.log(`  ${c.dim}â€¢${c.reset} Docs modified: ${docs}`);
  }

  console.log();

  // ============ FOCUS TIME ============
  console.log(`${c.bold}â±ï¸ FOCUS TIME${c.reset}`);

  // ActivityWatch
  if (reviewConfig.activityWatch?.enabled !== false) {
    const awData = exec(`curl -sL 'http://127.0.0.1:5600/api/0/buckets/' 2>/dev/null`, { timeout: 5000 });
    if (awData) {
      const buckets = parseJSON(awData);
      if (buckets) {
        const windowBucket = Object.keys(buckets).find(k => k.startsWith('aw-watcher-window'));
        if (windowBucket) {
          const eventsRaw = exec(`curl -sL 'http://127.0.0.1:5600/api/0/buckets/${windowBucket}/events?limit=500' 2>/dev/null`, { timeout: 10000 });
          const events = parseJSON(eventsRaw);
          if (Array.isArray(events)) {
            const apps = {};
            let total = 0;
            events.forEach(e => {
              const app = e.data?.app || 'unknown';
              const duration = e.duration || 0;
              apps[app] = (apps[app] || 0) + duration;
              total += duration;
            });
            const sortedApps = Object.entries(apps).sort((a, b) => b[1] - a[1]).slice(0, 5);
            console.log(`  ActivityWatch: ${(total / 3600).toFixed(1)} hrs`);
            sortedApps.forEach(([app, dur]) => {
              console.log(`    ${c.dim}${app}: ${Math.round(dur / 60)}min${c.reset}`);
            });
          }
        }
      }
    } else {
      console.log(`  ${c.yellow}ActivityWatch: not running${c.reset}`);
    }
  }

  // Screen Time
  if (reviewConfig.screenTime?.enabled) {
    const sshHost = reviewConfig.screenTime.sshHost || '';
    const scriptPath = reviewConfig.screenTime.scriptPath || '~/get_screentime.py';
    let screenTimeData;

    if (sshHost) {
      screenTimeData = exec(`ssh -o ConnectTimeout=5 -o BatchMode=yes ${sshHost} "python3 ${scriptPath} ${reviewDate}" 2>/dev/null`, { timeout: 15000 });
    } else {
      // Local Mac - query knowledgeC.db directly
      const localScript = scriptPath.replace(/^~/, os.homedir());
      if (fs.existsSync(localScript)) {
        screenTimeData = exec(`python3 "${localScript}" ${reviewDate} 2>/dev/null`, { timeout: 15000 });
      }
    }

    if (screenTimeData && screenTimeData !== 'No data found') {
      console.log();
      console.log(`  Screen Time${sshHost ? ' (remote)' : ''}:`);
      screenTimeData.split('\n').slice(0, 8).forEach(line => {
        if (line.trim()) console.log(`    ${c.dim}${line}${c.reset}`);
      });
    }
  }

  console.log();
  console.log(`${c.dim}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${c.reset}`);
  console.log(`${c.dim}Generated: ${new Date().toLocaleString()}${c.reset}`);
}

// â”€â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function main() {
  const args = parseArgs();
  
  if (args.version) {
    console.log(`morning-dashboard v${VERSION}`);
    process.exit(0);
  }
  
  if (args.help) {
    showHelp();
    process.exit(0);
  }
  
  let config = loadConfig();
  
  if (args.configPath && fs.existsSync(args.configPath)) {
    const customConfig = parseJSON(fs.readFileSync(args.configPath, 'utf-8'));
    if (customConfig) config = deepMerge(config, customConfig);
  }
  
  // Setup command
  if (args.command === 'setup') {
    switch (args.subcommand) {
      case 'status':
        await runSetupStatus(config);
        break;
      case 'google':
        await runSetupGoogle(config);
        break;
      case 'todoist':
        await runSetupTodoist(config);
        break;
      case 'github':
        await runSetupGitHub(config);
        break;
      case 'weather':
        await runSetupWeather(config);
        break;
      case 'review':
        await runSetupReview(config);
        break;
      default:
        await runSetupWizard(config);
    }
    process.exit(0);
  }
  
  // GUI command
  if (args.command === 'gui') {
    const port = args.port || config.gui?.port || 3141;
    startGUIServer(config, port);
    return;
  }

  // Review command
  if (args.command === 'review') {
    useColor = config.display.color;
    runDailyReview(args.reviewDate, config);
    process.exit(0);
  }
  
  // Terminal dashboard
  if (args.compact) config.display.compact = true;
  if (args.noColor) config.display.color = false;
  useColor = config.display.color && !args.json;
  
  const showAll = args.sections.length === 0;
  const shouldShow = (section) => showAll || args.sections.includes(section);
  
  const data = fetchAllData(config);
  
  if (args.json) {
    console.log(JSON.stringify(data, null, 2));
    process.exit(0);
  }
  
  if (!args.compact && showAll) console.clear();
  if (config.display.showGreeting && showAll) renderHeader(config, data.weather, data.system);
  if (config.quote?.enabled && showAll && !config.display.compact) renderQuote(config);
  console.log();
  
  if (shouldShow('tasks')) { renderTasks(data.tasks, config); console.log(); }
  if (shouldShow('calendar')) { renderCalendar(data.calendar.events, data.calendar.focusBlocks, config); console.log(); }
  if (shouldShow('email')) { renderEmails(data.email, config); console.log(); }
  if (shouldShow('github') && data.github.length > 0) { renderGitHub(data.github, config); console.log(); }

  // New integrations
  if (shouldShow('stocks') && data.stocks?.length > 0) { renderStocks(data.stocks, config); console.log(); }
  if (shouldShow('apple-calendar') && data.appleCalendar?.length > 0) { renderAppleCalendar(data.appleCalendar, config); console.log(); }
  if (shouldShow('apple-mail') && data.appleMail?.length > 0) { renderAppleMail(data.appleMail, config); console.log(); }

  if (config.display.showSummary && showAll) {
    renderFooter({
      overdueTasks: data.tasks.overdue.length,
      todayTasks: data.tasks.today.length,
      events: data.calendar.events.length,
      emails: data.email.length,
      github: data.github.length,
      stocks: data.stocks?.length || 0,
      appleCalendar: data.appleCalendar?.length || 0,
      appleMail: data.appleMail?.filter(e => e.unread)?.length || 0,
    }, config);
  }
}

main().catch(console.error);
